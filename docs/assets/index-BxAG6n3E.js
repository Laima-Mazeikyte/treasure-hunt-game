(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();function O(t){if(typeof t=="number")return(Math.abs(t*2654435761)>>>0).toString(16);if(typeof t=="boolean")return t?"1":"0";if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string"){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24),e=e>>>0;return e.toString(16)}if(Array.isArray(t)){let e=2166136261;for(let n=0;n<t.length;n++){e^=(n+1)*2654435761;const r=O(t[n]);for(let s=0;s<r.length;s++)e^=r.charCodeAt(s),e*=16777619,e=e>>>0}return e.toString(16)}if(typeof t=="object"){let e=2166136261;const n=Object.keys(t).sort();for(let r=0;r<n.length;r++){const s=n[r],o=O(s);e^=parseInt(o,16),e*=16777619,e=e>>>0;const i=O(t[s]);e^=parseInt(i,16),e*=16777619,e=e>>>0}return e.toString(16)}return O(String(t))}const S={Remove:"remove",Replace:"replace",Add:"add"},Un=Symbol.for("__MUTATIVE_PROXY_DRAFT__"),Ur=Symbol("__MUTATIVE_RAW_RETURN_SYMBOL__"),qe=Symbol.iterator,R={mutable:"mutable",immutable:"immutable"},Lt={};function Ce(t,e){return t instanceof Map?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function Jt(t,e){if(e in t){let n=Reflect.getPrototypeOf(t);for(;n;){const r=Reflect.getOwnPropertyDescriptor(n,e);if(r)return r;n=Reflect.getPrototypeOf(n)}}}function Ut(t){return Object.getPrototypeOf(t)===Set.prototype}function zt(t){return Object.getPrototypeOf(t)===Map.prototype}function j(t){var e;return(e=t.copy)!==null&&e!==void 0?e:t.original}function ee(t){return!!T(t)}function T(t){return typeof t!="object"?null:t?.[Un]}function Ft(t){var e;const n=T(t);return n?(e=n.copy)!==null&&e!==void 0?e:n.original:t}function K(t,e){if(!t||typeof t!="object")return!1;let n;return Object.getPrototypeOf(t)===Object.prototype||Array.isArray(t)||t instanceof Map||t instanceof Set||!!e?.mark&&((n=e.mark(t,R))===R.immutable||typeof n=="function")}function zn(t,e=[]){if(Object.hasOwnProperty.call(t,"key")){const n=t.parent.copy,r=T(Z(n,t.key));if(r!==null&&r?.original!==t.original)return null;const s=t.parent.type===3,o=s?Array.from(t.parent.setMap.keys()).indexOf(t.key):t.key;if(!(s&&n.size>o||Ce(n,o)))return null;e.push(o)}if(t.parent)return zn(t.parent,e);e.reverse();try{zr(t.copy,e)}catch{return null}return e}function oe(t){return Array.isArray(t)?1:t instanceof Map?2:t instanceof Set?3:0}function Z(t,e){return oe(t)===2?t.get(e):t[e]}function De(t,e,n){oe(t)===2?t.set(e,n):t[e]=n}function ct(t,e){const n=T(t);return(n?j(n):t)[e]}function Y(t,e){return t===e?t!==0||1/t===1/e:t!==t&&e!==e}function mt(t){if(t)for(;t.finalities.revoke.length>0;)t.finalities.revoke.pop()()}function re(t,e){return e?t:[""].concat(t).map(n=>{const r=`${n}`;return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}).join("/")}function zr(t,e){for(let n=0;n<e.length-1;n+=1){const r=e[n];if(t=Z(oe(t)===3?Array.from(t):t,r),typeof t!="object")throw new Error(`Cannot resolve patch at '${e.join("/")}'.`)}return t}function Fr(t){const e=Object.create(Object.getPrototypeOf(t));return Reflect.ownKeys(t).forEach(n=>{let r=Reflect.getOwnPropertyDescriptor(t,n);if(r.enumerable&&r.configurable&&r.writable){e[n]=t[n];return}r.writable||(r.writable=!0,r.configurable=!0),(r.get||r.set)&&(r={configurable:!0,writable:!0,enumerable:r.enumerable,value:t[n]}),Reflect.defineProperty(e,n,r)}),e}const Nr=Object.prototype.propertyIsEnumerable;function Fn(t,e){let n;if(Array.isArray(t))return Array.prototype.concat.call(t);if(t instanceof Set){if(!Ut(t)){const r=Object.getPrototypeOf(t).constructor;return new r(t.values())}return Set.prototype.difference?Set.prototype.difference.call(t,new Set):new Set(t.values())}else if(t instanceof Map){if(!zt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(t)}return new Map(t)}else if(e?.mark&&(n=e.mark(t,R),n!==void 0)&&n!==R.mutable){if(n===R.immutable)return Fr(t);if(typeof n=="function"){if(e.enablePatches||e.enableAutoFreeze)throw new Error("You can't use mark and patches or auto freeze together.");return n()}throw new Error(`Unsupported mark result: ${n}`)}else if(typeof t=="object"&&Object.getPrototypeOf(t)===Object.prototype){const r={};return Object.keys(t).forEach(s=>{r[s]=t[s]}),Object.getOwnPropertySymbols(t).forEach(s=>{Nr.call(t,s)&&(r[s]=t[s])}),r}else throw new Error("Please check mark() to ensure that it is a stable marker draftable function.")}function I(t){t.copy||(t.copy=Fn(t.original,t.options))}function we(t){if(!K(t))return Ft(t);if(Array.isArray(t))return t.map(we);if(t instanceof Map){const n=Array.from(t.entries()).map(([r,s])=>[r,we(s)]);if(!zt(t)){const r=Object.getPrototypeOf(t).constructor;return new r(n)}return new Map(n)}if(t instanceof Set){const n=Array.from(t).map(we);if(!Ut(t)){const r=Object.getPrototypeOf(t).constructor;return new r(n)}return new Set(n)}const e=Object.create(Object.getPrototypeOf(t));for(const n in t)e[n]=we(t[n]);return e}function Ke(t){return ee(t)?we(t):t}function W(t){var e;t.assignedMap=(e=t.assignedMap)!==null&&e!==void 0?e:new Map,t.operated||(t.operated=!0,t.parent&&W(t.parent))}function Yt(){throw new Error("Cannot modify frozen object")}function ue(t,e,n,r,s){{n=n??new WeakMap,r=r??[],s=s??[];const i=n.has(t)?n.get(t):t;if(r.length>0){const a=r.indexOf(i);if(i&&typeof i=="object"&&a!==-1)throw r[0]===i?new Error("Forbids circular reference"):new Error(`Forbids circular reference: ~/${s.slice(0,a).map((c,u)=>{if(typeof c=="symbol")return`[${c.toString()}]`;const l=r[u];return typeof c=="object"&&(l instanceof Map||l instanceof Set)?Array.from(l.keys()).indexOf(c):c}).join("/")}`);r.push(i),s.push(e)}else r.push(i)}if(Object.isFrozen(t)||ee(t)){r.pop(),s.pop();return}switch(oe(t)){case 2:for(const[a,c]of t)ue(a,a,n,r,s),ue(c,a,n,r,s);t.set=t.clear=t.delete=Yt;break;case 3:for(const a of t)ue(a,a,n,r,s);t.add=t.clear=t.delete=Yt;break;case 1:Object.freeze(t);let i=0;for(const a of t)ue(a,i,n,r,s),i+=1;break;default:Object.freeze(t),Object.keys(t).forEach(a=>{const c=t[a];ue(c,a,n,r,s)})}r.pop(),s.pop()}function Nt(t,e){const n=oe(t);if(n===0)Reflect.ownKeys(t).forEach(r=>{e(r,t[r],t)});else if(n===1){let r=0;for(const s of t)e(r,s,t),r+=1}else t.forEach((r,s)=>e(s,r,t))}function Nn(t,e,n){if(ee(t)||!K(t,n)||e.has(t)||Object.isFrozen(t))return;const r=t instanceof Set,s=r?new Map:void 0;if(e.add(t),Nt(t,(o,i)=>{var a;if(ee(i)){const c=T(i);I(c);const u=!((a=c.assignedMap)===null||a===void 0)&&a.size||c.operated?c.copy:c.original;De(r?s:t,o,u)}else Nn(i,e,n)}),s){const o=t,i=Array.from(o);o.clear(),i.forEach(a=>{o.add(s.has(a)?s.get(a):a)})}}function qr(t,e){const n=t.type===3?t.setMap:t.copy;t.finalities.revoke.length>1&&t.assignedMap.get(e)&&n&&Nn(Z(n,e),t.finalities.handledSet,t.options)}function bt(t){t.type===3&&t.copy&&(t.copy.clear(),t.setMap.forEach(e=>{t.copy.add(Ft(e))}))}function _t(t,e,n,r){if(t.operated&&t.assignedMap&&t.assignedMap.size>0&&!t.finalized){if(n&&r){const o=zn(t);o&&e(t,o,n,r)}t.finalized=!0}}function qt(t,e,n,r){const s=T(n);s&&(s.callbacks||(s.callbacks=[]),s.callbacks.push((o,i)=>{var a;const c=t.type===3?t.setMap:t.copy;if(Y(Z(c,e),n)){let u=s.original;s.copy&&(u=s.copy),bt(t),_t(t,r,o,i),t.options.enableAutoFreeze&&(t.options.updatedValues=(a=t.options.updatedValues)!==null&&a!==void 0?a:new WeakMap,t.options.updatedValues.set(u,s.original)),De(c,e,u)}}),t.options.enableAutoFreeze&&s.finalities!==t.finalities&&(t.options.enableAutoFreeze=!1)),K(n,t.options)&&t.finalities.draft.push(()=>{const o=t.type===3?t.setMap:t.copy;Y(Z(o,e),n)&&qr(t,e)})}function Kr(t,e,n,r,s){let{original:o,assignedMap:i,options:a}=t,c=t.copy;c.length<o.length&&([o,c]=[c,o],[n,r]=[r,n]);for(let u=0;u<o.length;u+=1)if(i.get(u.toString())&&c[u]!==o[u]){const l=e.concat([u]),f=re(l,s);n.push({op:S.Replace,path:f,value:Ke(c[u])}),r.push({op:S.Replace,path:f,value:Ke(o[u])})}for(let u=o.length;u<c.length;u+=1){const l=e.concat([u]),f=re(l,s);n.push({op:S.Add,path:f,value:Ke(c[u])})}if(o.length<c.length){const{arrayLengthAssignment:u=!0}=a.enablePatches;if(u){const l=e.concat(["length"]),f=re(l,s);r.push({op:S.Replace,path:f,value:o.length})}else for(let l=c.length;o.length<l;l-=1){const f=e.concat([l-1]),d=re(f,s);r.push({op:S.Remove,path:d})}}}function Br({original:t,copy:e,assignedMap:n},r,s,o,i){n.forEach((a,c)=>{const u=Z(t,c),l=Ke(Z(e,c)),f=a?Ce(t,c)?S.Replace:S.Add:S.Remove;if(Y(u,l)&&f===S.Replace)return;const d=r.concat(c),h=re(d,i);s.push(f===S.Remove?{op:f,path:h}:{op:f,path:h,value:l}),o.push(f===S.Add?{op:S.Remove,path:h}:f===S.Remove?{op:S.Add,path:h,value:u}:{op:S.Replace,path:h,value:u})})}function Vr({original:t,copy:e},n,r,s,o){let i=0;t.forEach(a=>{if(!e.has(a)){const c=n.concat([i]),u=re(c,o);r.push({op:S.Remove,path:u,value:a}),s.unshift({op:S.Add,path:u,value:a})}i+=1}),i=0,e.forEach(a=>{if(!t.has(a)){const c=n.concat([i]),u=re(c,o);r.push({op:S.Add,path:u,value:a}),s.unshift({op:S.Remove,path:u,value:a})}i+=1})}function Oe(t,e,n,r){const{pathAsArray:s=!0}=t.options.enablePatches;switch(t.type){case 0:case 2:return Br(t,e,n,r,s);case 1:return Kr(t,e,n,r,s);case 3:return Vr(t,e,n,r,s)}}const Ge=(t,e,n=!1)=>{if(typeof t=="object"&&t!==null&&(!K(t,e)||n))throw new Error("Strict mode: Mutable data cannot be accessed directly, please use 'unsafe(callback)' wrap.")},Tt={get size(){return j(T(this)).size},has(t){return j(T(this)).has(t)},set(t,e){const n=T(this),r=j(n);return(!r.has(t)||!Y(r.get(t),e))&&(I(n),W(n),n.assignedMap.set(t,!0),n.copy.set(t,e),qt(n,t,e,Oe)),this},delete(t){if(!this.has(t))return!1;const e=T(this);return I(e),W(e),e.original.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.copy.delete(t),!0},clear(){const t=T(this);if(this.size){I(t),W(t),t.assignedMap=new Map;for(const[e]of t.original)t.assignedMap.set(e,!1);t.copy.clear()}},forEach(t,e){const n=T(this);j(n).forEach((r,s)=>{t.call(e,this.get(s),s,this)})},get(t){var e,n;const r=T(this),s=j(r).get(t),o=((n=(e=r.options).mark)===null||n===void 0?void 0:n.call(e,s,R))===R.mutable;if(r.options.strict&&Ge(s,r.options,o),o||r.finalized||!K(s,r.options)||s!==r.original.get(t))return s;const i=Lt.createDraft({original:s,parentDraft:r,key:t,finalities:r.finalities,options:r.options});return I(r),r.copy.set(t,i),i},keys(){return j(T(this)).keys()},values(){const t=this.keys();return{[qe]:()=>this.values(),next:()=>{const e=t.next();return e.done?e:{done:!1,value:this.get(e.value)}}}},entries(){const t=this.keys();return{[qe]:()=>this.entries(),next:()=>{const e=t.next();if(e.done)return e;const n=this.get(e.value);return{done:!1,value:[e.value,n]}}}},[qe](){return this.entries()}},Hr=Reflect.ownKeys(Tt),Zt=(t,e,{isValuesIterator:n})=>()=>{var r,s;const o=e.next();if(o.done)return o;const i=o.value;let a=t.setMap.get(i);const c=T(a),u=((s=(r=t.options).mark)===null||s===void 0?void 0:s.call(r,a,R))===R.mutable;if(t.options.strict&&Ge(i,t.options,u),!u&&!c&&K(i,t.options)&&!t.finalized&&t.original.has(i)){const l=Lt.createDraft({original:i,parentDraft:t,key:i,finalities:t.finalities,options:t.options});t.setMap.set(i,l),a=l}else c&&(a=c.proxy);return{done:!1,value:n?a:[a,a]}},Qe={get size(){return T(this).setMap.size},has(t){const e=T(this);if(e.setMap.has(t))return!0;I(e);const n=T(t);return!!(n&&e.setMap.has(n.original))},add(t){const e=T(this);return this.has(t)||(I(e),W(e),e.assignedMap.set(t,!0),e.setMap.set(t,t),qt(e,t,t,Oe)),this},delete(t){if(!this.has(t))return!1;const e=T(this);I(e),W(e);const n=T(t);return n&&e.setMap.has(n.original)?(e.assignedMap.set(n.original,!1),e.setMap.delete(n.original)):(!n&&e.setMap.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.setMap.delete(t))},clear(){if(!this.size)return;const t=T(this);I(t),W(t);for(const e of t.original)t.assignedMap.set(e,!1);t.setMap.clear()},values(){const t=T(this);I(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.values(),next:Zt(t,e,{isValuesIterator:!0})}},entries(){const t=T(this);I(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.entries(),next:Zt(t,e,{isValuesIterator:!1})}},keys(){return this.values()},[qe](){return this.values()},forEach(t,e){const n=this.values();let r=n.next();for(;!r.done;)t.call(e,r.value,r.value,this),r=n.next()}};Set.prototype.difference&&Object.assign(Qe,{intersection(t){return Set.prototype.intersection.call(new Set(this.values()),t)},union(t){return Set.prototype.union.call(new Set(this.values()),t)},difference(t){return Set.prototype.difference.call(new Set(this.values()),t)},symmetricDifference(t){return Set.prototype.symmetricDifference.call(new Set(this.values()),t)},isSubsetOf(t){return Set.prototype.isSubsetOf.call(new Set(this.values()),t)},isSupersetOf(t){return Set.prototype.isSupersetOf.call(new Set(this.values()),t)},isDisjointFrom(t){return Set.prototype.isDisjointFrom.call(new Set(this.values()),t)}});const Wr=Reflect.ownKeys(Qe),qn={get(t,e,n){var r,s;const o=(r=t.copy)===null||r===void 0?void 0:r[e];if(o&&t.finalities.draftsCache.has(o))return o;if(e===Un)return t;let i;if(t.options.mark){const u=e==="size"&&(t.original instanceof Map||t.original instanceof Set)?Reflect.get(t.original,e):Reflect.get(t.original,e,n);if(i=t.options.mark(u,R),i===R.mutable)return t.options.strict&&Ge(u,t.options,!0),u}const a=j(t);if(a instanceof Map&&Hr.includes(e))return e==="size"?Object.getOwnPropertyDescriptor(Tt,"size").get.call(t.proxy):Tt[e].bind(t.proxy);if(a instanceof Set&&Wr.includes(e))return e==="size"?Object.getOwnPropertyDescriptor(Qe,"size").get.call(t.proxy):Qe[e].bind(t.proxy);if(!Ce(a,e)){const u=Jt(a,e);return u?"value"in u?u.value:(s=u.get)===null||s===void 0?void 0:s.call(t.proxy):void 0}const c=a[e];if(t.options.strict&&Ge(c,t.options),t.finalized||!K(c,t.options))return c;if(c===ct(t.original,e)){if(I(t),t.copy[e]=Kt({original:t.original[e],parentDraft:t,key:t.type===1?Number(e):e,finalities:t.finalities,options:t.options}),typeof i=="function"){const u=T(t.copy[e]);return I(u),W(u),u.copy}return t.copy[e]}return ee(c)&&t.finalities.draftsCache.add(c),c},set(t,e,n){var r;if(t.type===3||t.type===2)throw new Error("Map/Set draft does not support any property assignment.");let s;if(t.type===1&&e!=="length"&&!(Number.isInteger(s=Number(e))&&s>=0&&(e===0||s===0||String(s)===String(e))))throw new Error("Only supports setting array indices and the 'length' property.");const o=Jt(j(t),e);if(o?.set)return o.set.call(t.proxy,n),!0;const i=ct(j(t),e),a=T(i);return a&&Y(a.original,n)?(t.copy[e]=n,t.assignedMap=(r=t.assignedMap)!==null&&r!==void 0?r:new Map,t.assignedMap.set(e,!1),!0):(Y(n,i)&&(n!==void 0||Ce(t.original,e))||(I(t),W(t),Ce(t.original,e)&&Y(n,t.original[e])?t.assignedMap.delete(e):t.assignedMap.set(e,!0),t.copy[e]=n,qt(t,e,n,Oe)),!0)},has(t,e){return e in j(t)},ownKeys(t){return Reflect.ownKeys(j(t))},getOwnPropertyDescriptor(t,e){const n=j(t),r=Reflect.getOwnPropertyDescriptor(n,e);return r&&{writable:!0,configurable:t.type!==1||e!=="length",enumerable:r.enumerable,value:n[e]}},getPrototypeOf(t){return Reflect.getPrototypeOf(t.original)},setPrototypeOf(){throw new Error("Cannot call 'setPrototypeOf()' on drafts")},defineProperty(){throw new Error("Cannot call 'defineProperty()' on drafts")},deleteProperty(t,e){var n;return t.type===1?qn.set.call(this,t,e,void 0,t.proxy):(ct(t.original,e)!==void 0||e in t.original?(I(t),W(t),t.assignedMap.set(e,!1)):(t.assignedMap=(n=t.assignedMap)!==null&&n!==void 0?n:new Map,t.assignedMap.delete(e)),t.copy&&delete t.copy[e],!0)}};function Kt(t){const{original:e,parentDraft:n,key:r,finalities:s,options:o}=t,i=oe(e),a={type:i,finalized:!1,parent:n,original:e,copy:null,proxy:null,finalities:s,options:o,setMap:i===3?new Map(e.entries()):void 0};(r||"key"in t)&&(a.key=r);const{proxy:c,revoke:u}=Proxy.revocable(i===1?Object.assign([],a):a,qn);if(s.revoke.push(u),a.proxy=c,n){const l=n;l.finalities.draft.push((f,d)=>{var h,p;const g=T(c);let y=l.type===3?l.setMap:l.copy;const m=Z(y,r),b=T(m);if(b){let _=b.original;b.operated&&(_=Ft(m)),bt(b),_t(b,Oe,f,d),l.options.enableAutoFreeze&&(l.options.updatedValues=(h=l.options.updatedValues)!==null&&h!==void 0?h:new WeakMap,l.options.updatedValues.set(_,b.original)),De(y,r,_)}(p=g.callbacks)===null||p===void 0||p.forEach(_=>{_(f,d)})})}else{const l=T(c);l.finalities.draft.push((f,d)=>{bt(l),_t(l,Oe,f,d)})}return c}Lt.createDraft=Kt;function Gr(t,e,n,r,s){var o;const i=T(t),a=(o=i?.original)!==null&&o!==void 0?o:t,c=!!e.length;if(i?.operated)for(;i.finalities.draft.length>0;)i.finalities.draft.pop()(n,r);const u=c?e[0]:i?i.operated?i.copy:i.original:t;return i&&mt(i),s&&ue(u,u,i?.options.updatedValues),[u,n&&c?[{op:S.Replace,path:[],value:e[0]}]:n,r&&c?[{op:S.Replace,path:[],value:a}]:r]}function Qr(t,e){var n;const r={draft:[],revoke:[],handledSet:new WeakSet,draftsCache:new WeakSet};let s,o;e.enablePatches&&(s=[],o=[]);const a=((n=e.mark)===null||n===void 0?void 0:n.call(e,t,R))===R.mutable||!K(t,e)?t:Kt({original:t,parentDraft:null,finalities:r,options:e});return[a,(c=[])=>{const[u,l,f]=Gr(a,c,s,o,e.enableAutoFreeze);return e.enablePatches?[u,l,f]:u}]}function wt(t){const{rootDraft:e,value:n,useRawReturn:r=!1,isRoot:s=!0}=t;Nt(n,(o,i,a)=>{const c=T(i);if(c&&e&&c.finalities===e.finalities){t.isContainDraft=!0;const u=c.original;if(a instanceof Set){const l=Array.from(a);a.clear(),l.forEach(f=>a.add(o===f?u:f))}else De(a,o,u)}else typeof i=="object"&&i!==null&&(t.value=i,t.isRoot=!1,wt(t))}),s&&(t.isContainDraft||console.warn("The return value does not contain any draft, please use 'rawReturn()' to wrap the return value to improve performance."),r&&console.warn("The return value contains drafts, please don't use 'rawReturn()' to wrap the return value."))}function Kn(t){var e;const n=T(t);if(!K(t,n?.options))return t;const r=oe(t);if(n&&!n.operated)return n.original;let s;function o(){s=r===2?zt(t)?new Map(t):new(Object.getPrototypeOf(t)).constructor(t):r===3?Array.from(n.setMap.values()):Fn(t,n?.options)}if(n){n.finalized=!0;try{o()}finally{n.finalized=!1}}else s=t;if(Nt(s,(i,a)=>{if(n&&Y(Z(n.original,i),a))return;const c=Kn(a);c!==a&&(s===t&&o(),De(s,i,c))}),r===3){const i=(e=n?.original)!==null&&e!==void 0?e:s;return Ut(i)?new Set(s):new(Object.getPrototypeOf(i)).constructor(s)}return s}function Xt(t){if(!ee(t))throw new Error(`current() is only used for Draft, parameter: ${t}`);return Kn(t)}const Jr=t=>function e(n,r,s){var o,i,a;if(typeof n=="function"&&typeof r!="function")return function(w,...D){return e(w,F=>n.call(this,F,...D),r)};const c=n,u=r;let l=s;if(typeof r!="function"&&(l=r),l!==void 0&&Object.prototype.toString.call(l)!=="[object Object]")throw new Error(`Invalid options: ${l}, 'options' should be an object.`);l=Object.assign(Object.assign({},t),l);const f=ee(c)?Xt(c):c,d=Array.isArray(l.mark)?((w,D)=>{for(const F of l.mark){if(typeof F!="function")throw new Error(`Invalid mark: ${F}, 'mark' should be a function.`);const G=F(w,D);if(G)return G}}):l.mark,h=(o=l.enablePatches)!==null&&o!==void 0?o:!1,p=(i=l.strict)!==null&&i!==void 0?i:!1,y={enableAutoFreeze:(a=l.enableAutoFreeze)!==null&&a!==void 0?a:!1,mark:d,strict:p,enablePatches:h};if(!K(f,y)&&typeof f=="object"&&f!==null)throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");const[m,b]=Qr(f,y);if(typeof r!="function"){if(!K(f,y))throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");return[m,b]}let _;try{_=u(m)}catch(w){throw mt(T(m)),w}const E=w=>{const D=T(m);if(!ee(w)){if(w!==void 0&&!Y(w,m)&&D?.operated)throw new Error("Either the value is returned as a new non-draft value, or only the draft is modified without returning any value.");const G=w?.[Ur];if(G){const Le=G[0];return y.strict&&typeof w=="object"&&w!==null&&wt({rootDraft:D,value:w,useRawReturn:!0}),b([Le])}if(w!==void 0)return typeof w=="object"&&w!==null&&wt({rootDraft:D,value:w}),b([w])}if(w===m||w===void 0)return b([]);const F=T(w);if(y===F.options){if(F.operated)throw new Error("Cannot return a modified child draft.");return b([Xt(w)])}return b([w])};return _ instanceof Promise?_.then(E,w=>{throw mt(T(m)),w}):E(_)},Je=Jr();Object.prototype.constructor.toString();function Bn(t,e){const n=Object.keys(t),r=Object.keys(e);return n.length===r.length&&Object.keys(t).every(s=>e.hasOwnProperty(s))}function en(t,e){return Object.keys(t).length===Object.keys(e).length&&Object.keys(t).every(n=>e.hasOwnProperty(n)&&t[n]===e[n])}function Be(t,e){return typeof t!="object"||typeof e!="object"||t===null||e===null?t===e:Bn(t,e)?Object.keys(t).every(n=>Be(t[n],e[n])):!1}function Bt(t){if(!ve(t))return t;const e={};for(const[n,r]of Object.entries(t))r!==void 0&&(e[n]=r);return e}function Vn(t,e){if(!ve(t)||!ve(e))return e;const n={...t};for(const r of Object.keys(e)){if(e[r]===void 0)continue;if(e[r]===null){delete n[r];continue}const s=ve(t[r])&&ve(e[r]);n[r]=s?Vn(t[r],e[r]):e[r]}return n}function ve(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function Yr(t,e,n){if(!t||e.length===0)return;let r=t||{};for(let o=0;o<e.length-1;o++){const i=e[o];(!(i in r)||typeof r[i]!="object")&&(r[i]=typeof e[o+1]=="number"?[]:{}),r=r[i]}const s=e[e.length-1];Array.isArray(r)&&typeof s=="number"?r.splice(s,0,n):r[s]=n}function tn(t,e,n){if(!t||e.length===0)return;let r=t||{};for(let s=0;s<e.length-1;s++){const o=e[s];(!(o in r)||typeof r[o]!="object")&&(r[o]=typeof e[s+1]=="number"?[]:{}),r=r[o]}r[e[e.length-1]]=n}function Hn(t,e){if(!t||e.length===0)return;const[n,...r]=e;if(n in t){if(r.length===0){Array.isArray(t)?t.splice(n,1):delete t[n];return}Hn(t[n],r),Zr(t[n])&&delete t[n]}}function Zr(t){return t&&Object.keys(t).length===0}const nn=/ZULU|YEKT|YEKST|YAPT|YAKT|YAKST|XJT|WGT|WGST|WFT|WETDST|WET|WDT|WAT|WAST|WAKT|WADT|VUT|VOLT|VLAT|VLAST|VET|UZT|UZST|UYT|UYST|UTC|UT|ULAT|ULAST|UCT|TVT|TRUT|TOT|TMT|TKT|TJT|TFT|TAHT|SGT|SCT|SAST|SADT|RET|PYT|PYST|PWT|PST|PONT|PMST|PMDT|PKT|PKST|PHT|PGT|PETT|PETST|PET|PDT|OMST|OMSST|NZT|NZST|NZDT|NUT|NST|NPT|NOVT|NOVST|NFT|NDT|MYT|MVT|MUT|MUST|MST|MSK|MSD|MPT|MMT|MHT|MEZ|METDST|MET|MESZ|MEST|MDT|MAWT|MART|MAGT|MAGST|LKT|LINT|LIGT|LHST|LHDT|KST|KRAT|KRAST|KOST|KGT|KGST|KDT|JST|JAYT|IST|IRT|IRKT|IRKST|IOT|IDT|ICT|HST|HKT|GYT|GMT|GILT|GFT|GET|GEST|GAMT|GALT|FNT|FNST|FKT|FKST|FJT|FJST|FET|EST|EGT|EGST|EETDST|EET|EEST|EDT|EAT|EAST|EASST|DDUT|DAVT|CXT|CST|COT|CLT|CLST|CKT|CHUT|CHAST|CHADT|CETDST|CET|CEST|CDT|CCT|CAST|CADT|BTT|BST|BRT|BRST|BRA|BOT|BORT|BNT|BDT|BDST|AZT|AZST|AZOT|AZOST|AWST|AWSST|AST|ART|ARST|ANAT|ANAST|AMT|AMST|ALMT|ALMST|AKST|AKDT|AFT|AEST|AESST|AEDT|ADT|ACWST|ACT|ACST|ACSST|ACDT$/,Xr={ZULU:0,YEKT:18e3,YEKST:21600,YAPT:36e3,YAKT:32400,YAKST:32400,XJT:21600,WGT:-10800,WGST:-7200,WFT:43200,WETDST:3600,WET:0,WDT:32400,WAT:3600,WAST:25200,WAKT:43200,WADT:28800,VUT:39600,VOLT:10800,VLAT:36e3,VLAST:36e3,VET:-14400,UZT:18e3,UZST:21600,UYT:-10800,UYST:-7200,UTC:0,UT:0,ULAT:28800,ULAST:32400,UCT:0,TVT:43200,TRUT:36e3,TOT:46800,TMT:18e3,TKT:46800,TJT:18e3,TFT:18e3,TAHT:-36e3,SGT:28800,SCT:14400,SAST:7200,SADT:37800,RET:14400,PYT:-14400,PYST:-10800,PWT:32400,PST:-28800,PONT:39600,PMST:-10800,PMDT:-7200,PKT:18e3,PKST:21600,PHT:28800,PGT:36e3,PETT:43200,PETST:43200,PET:-18e3,PDT:-25200,OMST:21600,OMSST:21600,NZT:43200,NZST:43200,NZDT:46800,NUT:-39600,NST:-12600,NPT:20700,NOVT:25200,NOVST:25200,NFT:-12600,NDT:-9e3,MYT:28800,MVT:18e3,MUT:14400,MUST:18e3,MST:-25200,MSK:10800,MSD:14400,MPT:36e3,MMT:23400,MHT:43200,MEZ:3600,METDST:7200,MET:3600,MESZ:7200,MEST:7200,MDT:-21600,MAWT:18e3,MART:-34200,MAGT:39600,MAGST:39600,LKT:19800,LINT:50400,LIGT:36e3,LHST:37800,LHDT:37800,KST:32400,KRAT:25200,KRAST:25200,KOST:39600,KGT:21600,KGST:21600,KDT:36e3,JST:32400,JAYT:32400,IST:7200,IRT:12600,IRKT:28800,IRKST:28800,IOT:21600,IDT:10800,ICT:25200,HST:-36e3,HKT:28800,GYT:-14400,GMT:0,GILT:43200,GFT:-10800,GET:14400,GEST:14400,GAMT:-32400,GALT:-21600,FNT:-7200,FNST:-3600,FKT:-10800,FKST:-10800,FJT:43200,FJST:46800,FET:10800,EST:-18e3,EGT:-3600,EGST:0,EETDST:10800,EET:7200,EEST:10800,EDT:-14400,EAT:10800,EAST:-21600,EASST:-21600,DDUT:36e3,DAVT:25200,CXT:25200,CST:-21600,COT:-18e3,CLT:-14400,CLST:-10800,CKT:-36e3,CHUT:36e3,CHAST:45900,CHADT:49500,CETDST:7200,CET:3600,CEST:7200,CDT:-18e3,CCT:28800,CAST:34200,CADT:37800,BTT:21600,BST:3600,BRT:-10800,BRST:-7200,BRA:-10800,BOT:-14400,BORT:28800,BNT:28800,BDT:21600,BDST:7200,AZT:14400,AZST:14400,AZOT:-3600,AZOST:0,AWST:28800,AWSST:32400,AST:-14400,ART:-10800,ARST:-10800,ANAT:43200,ANAST:43200,AMT:-14400,AMST:14400,ALMT:21600,ALMST:25200,AKST:-32400,AKDT:-28800,AFT:16200,AEST:36e3,AESST:39600,AEDT:39600,ADT:-10800,ACWST:31500,ACT:-18e3,ACST:34200,ACSST:37800,ACDT:37800};function es(t){return new Date(t)}function ts(t){return new Date(t+"Z")}const ns=/^(\d+)[\./-](\d+)[\./-](\d+)$/;function rs(t){const e=t.match(ns);if(!e)return null;const[n,r,s,o]=e;return r<=0||s<=0||o<=0?null:r>999?new Date(Date.UTC(r,s-1,o,0,0,0,0)):new Date(Date.UTC(o,r-1,s,0,0,0,0))}function ss(t){const[e,n]=t.split(" ");return new Date(e+"T"+n+"Z")}function os(t){const[e,n]=t.split(" ");return new Date(e+"T"+n+"Z")}function is(t){return new Date(t)}function as(t){const e=/^(\w{3}) (\w{3}) (\d{2}) (\d{4})$/;if(!t.match(e))throw new Error(`Unable to parse \`${t}\` as a date.`);const r=new Date(t+" UTC");return new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),0,0,0,0))}function cs(t){const e=/^(.+T.+)([+-])(\d{2})$/,n=t.match(e);if(n){const[,r,s,o]=n,i=`${r}${s}${o}:00`;return new Date(i)}return null}function us(t){const e=/^(\d+)-(\d{1,2})-(\d{1,2})([ T])(.+)$/,n=t.match(e);if(n){const[,r,s,o,i,a]=n,c=s.padStart(2,"0"),u=o.padStart(2,"0"),l=`${r}-${c}-${u}T${a}`;return new Date(l)}return null}function ls(t){const[e,n]=t.split(", "),[r,s,o]=e.split("/").map(Number),i=n.match(/(\d{1,2}):(\d{2}):(\d{2}) (AM|PM)/);if(!i)throw new Error(`Unable to parse time from: ${t}`);let[,a,c,u,l]=i;return a=Number(a),c=Number(c),u=Number(u),l==="PM"&&a!==12?a+=12:l==="AM"&&a===12&&(a=0),new Date(Date.UTC(o,r-1,s,a,c,u))}function ds(t){switch(t){case"epoch":return new Date(0);case"infinity":case"-infinity":case"today":case"tomorrow":case"yesterday":return null}}function fs(t){const e=t.match(nn);if(!e)return null;const[n]=e,r=Xr[n],s=new Date(t.replace(nn,"Z"));return new Date(s.getTime()-r*1e3)}const hs=[rs,os,as,ls,is,ts,cs,ss,es,ds,fs,us];function ps(t,e){try{const n=t(e);return n instanceof Date&&!isNaN(n.getTime())?n:null}catch{return null}}function vt(t){for(const e of hs){const n=ps(e,t);if(n)return n}return null}function ys(t){try{const e=JSON.parse(t);return typeof e=="string"?vt(e):null}catch{return null}}function tt(t){if(t!==void 0){if(t===null)return null;if(t instanceof Date)return t;if(typeof t=="string"){const e=vt(t)||ys(t)||vt(t.trim());if(!e)throw new Error(`Unable to parse \`${t}\` as a date.`);return e}else if(typeof t=="number")return new Date(t);throw new Error(`Invalid date value \`${t}\`. Expected a date, number, or string, got type ${typeof t}.`)}}class se{attrs;linkIndex;_blobAttrs=null;_primaryKeys=null;_forwardIdents=null;_revIdents=null;constructor(e,n){this.attrs=e,this.linkIndex=n}resetAttrIndexes(){this._blobAttrs=null,this._primaryKeys=null,this._forwardIdents=null,this._revIdents=null}addAttr(e){this.attrs[e.id]=e,this.resetAttrIndexes()}deleteAttr(e){delete this.attrs[e],this.resetAttrIndexes()}updateAttr(e){const n=this.attrs[e.id];n&&(this.attrs[e.id]={...n,...e},this.resetAttrIndexes())}getAttr(e){return this.attrs[e]}get blobAttrs(){if(this._blobAttrs)return this._blobAttrs;this._blobAttrs=new Map;for(const e of Object.values(this.attrs))if(Ht(e)){const[n,r,s]=e["forward-identity"];x(this.blobAttrs,[r,s],e)}return this._blobAttrs}get primaryKeys(){if(this._primaryKeys)return this._primaryKeys;this._primaryKeys=new Map;for(const e of Object.values(this.attrs))if(e["primary?"]){const[n,r]=e["forward-identity"];x(this._primaryKeys,[r],e)}return this._primaryKeys}get forwardIdents(){if(this._forwardIdents)return this._forwardIdents;this._forwardIdents=new Map;for(const e of Object.values(this.attrs)){const n=e["forward-identity"],[r,s,o]=n;x(this._forwardIdents,[s,o],e)}return this._forwardIdents}get revIdents(){if(this._revIdents)return this._revIdents;this._revIdents=new Map;for(const e of Object.values(this.attrs)){const n=e["reverse-identity"];if(n){const[r,s,o]=n;x(this._revIdents,[s,o],e)}}return this._revIdents}toJSON(){return{attrs:this.attrs,linkIndex:this.linkIndex}}}function gs(t){return t.cardinality==="one"}function Vt(t){return t["value-type"]==="ref"}function Ht(t){return t["value-type"]==="blob"}function me(t,e){return e.reduce((n,r)=>n&&n.get(r),t)}function N(t,e){if(e.length===0)throw new Error("path must have at least one element");if(e.length===1){t.delete(e[0]);return}const[n,...r]=e;t.has(n)&&N(t.get(n),r)}function x(t,e,n){let r=t;const s=e.length-1;for(let o=0;o<s;o++){const i=e[o];let a=r.get(i);a===void 0&&(a=new Map,r.set(i,a)),r=a}s>-1&&r.set(e[s],n)}function Wn(t,e,n){const r=new Map,s=new Map,o=new Map;for(const i of e){let[a,c,u]=i;const l=t.getAttr(c);if(!l){console.warn("no such attr",c,a);continue}l["checked-data-type"]==="date"&&n&&(u=tt(u),i[2]=u),Vt(l)&&x(o,[u,c,a],i),x(r,[a,c,u],i),x(s,[c,a,u],i)}return{eav:r,aev:s,vae:o}}function Gn(t){return{triples:P(t.eav,3),cardinalityInference:t.cardinalityInference,useDateObjects:t.useDateObjects,version:1}}function Qn(t,e){return Se(t,e.triples,e.cardinalityInference,e.useDateObjects)}function Jn(t,e){if(t)return new se(t.attrs,t.linkIndex);if(e&&"__type"in e)return new se(e.attrs,e.linkIndex)}function ms(t,e){return me(t.eav,[e])!==void 0}function Se(t,e,n,r){const s=Wn(t,e,r);return s.cardinalityInference=n,s.useDateObjects=r,s}function je(t,e){let n;if(Array.isArray(e[0])){const[s,o]=e[0],i=t.aev.get(s);if(!i)return null;n=P(i,2).find(c=>c[2]===o)?.[0]}else n=e[0];if(!n)return null;const r=e[2];if(Array.isArray(r)&&r.length===2&&t.aev.get(r[0])){const[s,o]=r,i=t.aev.get(s);if(!i)return null;const c=P(i,2).find(h=>h[2]===o)?.[0];if(!c)return null;const[u,l,f,...d]=e;return[n,l,c,...d]}else{const[s,...o]=e;return[n,...o]}}function Yn(t,e,n){const r=je(t,n);if(!r)return;const[s,o,i]=r,a=e.getAttr(o);a&&(N(t.eav,[s,o,i]),N(t.aev,[o,s,i]),Vt(a)&&N(t.vae,[i,o,s]))}let bs=0;function Zn(t,e,n){const[r,s,o]=n;let i;const a=me(t.eav,[r,s,o]);return a&&(i=a[3]),i||Date.now()*10+bs++}function Xn(t,e,n){const r=je(t,n);if(!r)return;let[s,o,i]=r;const a=e.getAttr(o);if(!a)return;a["checked-data-type"]==="date"&&t.useDateObjects&&(i=tt(i));const u=me(t.eav,[s,o,i])?.[3]??Zn(t,a,r),l=[s,o,i,u];gs(a)?(x(t.eav,[s,o],new Map([[i,l]])),x(t.aev,[o,s],new Map([[i,l]]))):(x(t.eav,[s,o,i],l),x(t.aev,[o,s,i],l)),Vt(a)&&x(t.vae,[i,o,s],l)}function _s(t,e,n){const r=je(t,n);if(!r)return;const[s,o,i]=r,a=e.getAttr(o);if(!a)return;if(!Ht(a))throw new Error("merge operation is not supported for links");const c=me(t.eav,[s,o]);if(!c)return;const u=c.values().next()?.value;if(!u)return;const l=u[2],f=Vn(l,i),d=[s,o,f,Zn(t,a,u)];x(t.eav,[s,o],new Map([[f,d]])),x(t.aev,[o,s],new Map([[f,d]]))}function St(t,e,n){const[r,s]=n,o=je(t,[r]);if(!o)return;const[i]=o,a=t.eav.get(i);if(a){for(const u of a.keys()){const l=e.getAttr(u);l&&l["on-delete-reverse"]==="cascade"&&P(a.get(u),1).forEach(([f,d,h])=>St(t,e,[h,l["reverse-identity"]?.[1]])),(!s||!l||l["forward-identity"]?.[1]===s)&&(N(t.aev,[u,i]),N(t.eav,[i,u]))}a.size===0&&N(t.eav,[i])}const c=t.vae.get(i)&&P(t.vae.get(i),2);c&&c.forEach(u=>{const[l,f,d]=u,h=e.getAttr(f);(!s||!h||h["reverse-identity"]?.[1]===s)&&(N(t.eav,[l,f,d]),N(t.aev,[f,l,d]),N(t.vae,[d,f,l])),h&&h["on-delete"]==="cascade"&&h["reverse-identity"]?.[1]===s&&St(t,e,[l,h["forward-identity"]?.[1]])}),t.vae.get(i)?.size===0&&N(t.vae,[i])}function er(t,e,n){const r=Wn(e,n,t.useDateObjects);Object.keys(r).forEach(s=>{t[s]=r[s]})}function Ts(t,[e]){t.addAttr(e)}function tr(t){return P(t.eav,3)}function ws(t,e,[n]){if(!e.getAttr(n))return;const r=tr(t).filter(([s,o])=>o!==n);e.deleteAttr(n),er(t,e,r)}function vs(t,e,[n]){e.getAttr(n.id)&&(e.updateAttr(n),er(t,e,tr(t)))}function Ss(t,e,n){const[r,...s]=n;switch(r){case"add-triple":Xn(t,e,s);break;case"deep-merge-triple":_s(t,e,s);break;case"retract-triple":Yn(t,e,s);break;case"delete-entity":St(t,e,s);break;case"add-attr":Ts(e,s);break;case"delete-attr":ws(t,e,s);break;case"update-attr":vs(t,e,s);break;case"restore-attr":break;case"rule-params":break;default:throw new Error(`unhandled transaction action: ${r}`)}}function P(t,e,n=[]){if(!t||e===0)return n;if(e===1){for(const r of t.values())n.push(r);return n}for(const r of t.values())P(r,e-1,n);return n}function Ue(t,e,n){const r=[];if(n?.hasOwnProperty("$not")){for(const o of e.keys())n.$not!==o&&r.push(e.get(o));return r}if(n?.hasOwnProperty("$isNull")){const{attrId:o,isNull:i,reverse:a}=n.$isNull;if(a)for(const c of e.keys()){const u=t.vae.get(c),l=!u||!u.get(o);(i?l:!l)&&r.push(e.get(c))}else{const c=t.aev.get(o);for(const u of e.keys()){const l=!c||c.get(u)?.get(null)||!c.get(u);(i?l:!l)&&r.push(e.get(u))}}return r}if(n?.$comparator)return P(e,1).filter(n.$op);const s=n.in||n.$in||[n];for(const o of s){const i=e.get(o);i&&r.push(i)}return r}function As(t,e,n){let r="";return t!==void 0&&(r+="e"),e!==void 0&&(r+="a"),n!==void 0&&(r+="v"),r}function Cs(t,[e,n,r]){switch(As(e,n,r)){case"e":{const o=t.eav.get(e);return P(o,2)}case"ea":{const o=t.eav.get(e)?.get(n);return P(o,1)}case"eav":{const o=t.eav.get(e)?.get(n);return o?Ue(t,o,r):[]}case"ev":{const o=t.eav.get(e);if(!o)return[];const i=[];for(const a of o.values())i.push(...Ue(t,a,r));return i}case"a":{const o=t.aev.get(n);return P(o,2)}case"av":{const o=t.aev.get(n);if(!o)return[];const i=[];for(const a of o.values())i.push(...Ue(t,a,r));return i}case"v":{const o=[];for(const i of t.eav.values())for(const a of i.values())o.push(...Ue(t,a,r));return o}default:return P(t.eav,3)}}function Es(t,e,n){const r={};if(!e)return r;for(const[s,o]of e.entries()){const i=t.eav.get(n)?.get(o.id),a=P(i,1);for(const c of a)r[s]=c[2]}return r}function A(t,e,n){return t.forwardIdents.get(e)?.get(n)}function ie(t,e,n){return t.revIdents.get(e)?.get(n)}function Ms(t,e){return t.blobAttrs.get(e)}function nr(t,e){const n=t.primaryKeys.get(e);return n||t.forwardIdents.get(e)?.get("id")}function Os(t,e,n){const r=je(t,n);if(!r)return;const[s,o,i]=r;if(e.getAttr(o))return me(t.eav,[s,o])}function ks(t,e,n){const r=n.filter(([s,o,i,a,c])=>{if(s!=="add-triple"&&s!=="deep-merge-triple")return!0;const u=c?.mode;if(u!=="create"&&u!=="update")return!0;let l=!1;const f=e.getAttr(i);if(f){const d=nr(e,f["forward-identity"][1]);l=!!Os(t,e,[o,d?.id,o])}return!(u==="create"&&l||u==="update"&&!l)});return Je({store:t,attrsStore:e},s=>{r.forEach(o=>{Ss(s.store,s.attrsStore,o)})},{mark:s=>{if(s instanceof se)return"immutable"}})}function Is(t){return typeof t=="string"&&t.startsWith("?")}function xs(t,e,n){if(n.hasOwnProperty(t)){const r=n[t];return rr(r,e,n)}return{...n,[t]:e}}function rn(t,e,n){return t===e?n:null}function Ps(t){return typeof t==="string"&&t.startsWith("?")?xs:rn}const $s=["in","$in","$not","$isNull","$comparator"];function Ds(t){for(const e of $s)if(t.hasOwnProperty(e))return!0;return!1}function rr(t,e,n){return n?typeof t=="object"?Ds(t)?n:null:Ps(t)(t,e,n):null}function js(t,e,n){return t.reduce((r,s,o)=>{const i=e[o];return rr(s,i,r)},n)}function Rs(t,e,n){return zs(t,e,n).map(r=>js(e,r,n)).filter(r=>r)}function Ls(t,e,n){return e.or?e.or.patterns.flatMap(r=>At(t,r,n)):e.and?e.and.patterns.reduce((r,s)=>At(t,s,r),n):n.flatMap(r=>Rs(t,e,r))}function At(t,e,n=[{}]){return e.reduce((r,s)=>Ls(t,s,r),n)}function Wt(t,e){return Array.isArray(e)?e.map(n=>Wt(t,n)):Is(e)?t[e]:e}function Us(t,{find:e,where:n}){return At(t,n).map(s=>Wt(s,e))}function zs(t,e,n){return Cs(t,Wt(n,e))}const Fs=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function de(t){return typeof t=="string"&&Fs.test(t)}const M=[];for(let t=0;t<256;++t)M.push((t+256).toString(16).slice(1));function Ns(t,e=0){return(M[t[e+0]]+M[t[e+1]]+M[t[e+2]]+M[t[e+3]]+"-"+M[t[e+4]]+M[t[e+5]]+"-"+M[t[e+6]]+M[t[e+7]]+"-"+M[t[e+8]]+M[t[e+9]]+"-"+M[t[e+10]]+M[t[e+11]]+M[t[e+12]]+M[t[e+13]]+M[t[e+14]]+M[t[e+15]]).toLowerCase()}let ut;const qs=new Uint8Array(16);function Ks(){if(!ut){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ut=crypto.getRandomValues.bind(crypto)}return ut(qs)}const Bs=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),sn={randomUUID:Bs};function Vs(t,e,n){if(sn.randomUUID&&!t)return sn.randomUUID();t=t||{};const r=t.random??t.rng?.()??Ks();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Ns(r)}function on(t){const e=t.replace(/-/g,""),n=[];for(let r=0;r<e.length;r+=2)n.push(parseInt(e.substring(r,r+2),16));return n}function Hs(t,e){for(let n=0;n<t.length;n++){if(t[n]<e[n])return-1;if(t[n]>e[n])return 1}return 0}function Ws(t,e){return Hs(on(t),on(e))}function C(){return Vs()}function Gs(t,e){return t.localeCompare(e)}function Qs(){let t=Gs;if(typeof Intl=="object"&&Intl.hasOwnProperty("Collator"))try{t=Intl.Collator("en-US").compare}catch{}return t}const Js=Qs();let Ys=0;function Ee(t){return nt(`_${t}`,Ys++)}function nt(t,e){return`?${t}-${e}`}class fe extends Error{constructor(e){super(e),this.name="AttrNotFoundError"}}function Zs(t,e){const n=nr(t,e);if(!n)throw new fe(`Could not find id attr for ${e}`);return n}function an(t,e,n,r){return[Xs(t,e,n,r)]}function Xs(t,e,n,r){return[t(n,r),Zs(e,n).id,t(n,r),t("time",r)]}function eo(t,e,n){return t.map(r=>r===e?n:r)}function sr(t,e,n,r,s){const o=A(e,n,s),i=ie(e,n,s),a=o||i;if(!a)throw new fe(`Could not find attr for ${[n,s]}`);if(a["value-type"]!=="ref")throw new Error(`Attr ${a.id} is not a ref`);const[c,u]=a["forward-identity"],[l,f]=a["reverse-identity"],d=r+1,h=o?[t(u,r),a.id,t(f,d),Ee("time")]:[t(u,d),a.id,t(f,r),Ee("time")];return[o?f:u,d,h,a,!!o]}function cn(t,e){if(typeof e!="string")return function(i){return!1};const r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/%/g,".*").replace(/_/g,"."),s=new RegExp(`^${r}$`,t?void 0:"i");return function(i){return typeof i!="string"?!1:s.test(i)}}function to(t,e){if(typeof e!="object"||e.hasOwnProperty("$in")||e.hasOwnProperty("in"))return e;const n=t["checked-data-type"]==="date";if(e.hasOwnProperty("$gt"))return{$comparator:!0,$op:n?function(s){return new Date(s[2])>new Date(e.$gt)}:function(s){return s[2]>e.$gt}};if(e.hasOwnProperty("$gte"))return{$comparator:!0,$op:n?function(s){return new Date(s[2])>=new Date(e.$gte)}:function(s){return s[2]>=e.$gte}};if(e.hasOwnProperty("$lt"))return{$comparator:!0,$op:n?function(s){return new Date(s[2])<new Date(e.$lt)}:function(s){return s[2]<e.$lt}};if(e.hasOwnProperty("$lte"))return{$comparator:!0,$op:n?function(s){return new Date(s[2])<=new Date(e.$lte)}:function(s){return s[2]<=e.$lte}};if(e.hasOwnProperty("$like")){const r=cn(!0,e.$like);return{$comparator:!0,$op:function(o){return r(o[2])}}}if(e.hasOwnProperty("$ilike")){const r=cn(!1,e.$ilike);return{$comparator:!0,$op:function(o){return r(o[2])}}}return e}function no(t,e,n,r,s,o){const i=A(e,n,s),a=ie(e,n,s),c=i||a;if(!c)throw new fe(`No attr for etype = ${n} label = ${s}`);if(o?.hasOwnProperty("$isNull")){const u=A(e,n,"id");if(!u)throw new fe(`No attr for etype = ${n} label = id`);return[t(n,r),u.id,{$isNull:{attrId:c.id,isNull:o.$isNull,reverse:!i}},Ee("time")]}return i?[t(n,r),c.id,to(c,o),Ee("time")]:[o,c.id,t(n,r),Ee("time")]}function ro(t,e,n,r,s){const[o,i,a]=s.reduce((c,u)=>{const[l,f,d]=c,[h,p,g]=sr(t,e,l,f,u);return[h,p,[...d,g]]},[n,r,[]]);return[o,i,a]}function Ct(t,e,n,r,s,o){const i=s.slice(0,s.length-1),a=s[s.length-1],[c,u,l]=ro(t,e,n,r,i),f=no(t,e,c,u,a,o);return l.concat([f])}function so(t,e){return e?[e].concat(t):t}function oo([t,e]){return t==="or"&&Array.isArray(e)}function io([t,e]){return t==="and"&&Array.isArray(e)}function ao(t,e,n){return(r,s)=>{const o=t(r,s);return e==o?o:`${o}-${n}`}}function un(t,e,n,r,s,o){const i=t(r,s),a=o.map((c,u)=>{const l=ao(t,i,u);return or(l,n,r,s,c)});return{[e]:{patterns:a,joinSym:i}}}function co(t){const e=[];for(let n=1;n<=t.length;n++)e.push(t.slice(0,n));return e}function ln(t,e,n,r,s){return co(s).map(o=>Ct(t,e,n,r,o,{$isNull:!0}))}function or(t,e,n,r,s){return Object.entries(s).flatMap(([o,i])=>{if(oo([o,i]))return un(t,"or",e,n,r,i);if(io([o,i]))return un(t,"and",e,n,r,i);if(o==="$entityIdStartsWith")return[];const a=o.split(".");if(i?.hasOwnProperty("$ne")&&(i={...i,$not:i.$ne},delete i.$ne),i?.hasOwnProperty("$not")){const c=Ct(t,e,n,r,a,i),u=ln(t,e,n,r,a);return[{or:{patterns:[c,...u],joinSym:t(n,r)}}]}return i?.hasOwnProperty("$isNull")&&i.$isNull===!0&&a.length>1?[{or:{patterns:ln(t,e,n,r,a),joinSym:t(n,r)}}]:Ct(t,e,n,r,a,i)})}function uo(t,e,n,r){const s=nt;return r?or(s,t,e,n,r).concat(an(s,t,e,n)):an(s,t,e,n)}function lo(t,e,n){return[t(e,n),t("time",n)]}function fo(t,e,n,r,s,o){const[i,a,c,u,l]=sr(t,e,n,r,s),f=eo(c,t(n,r),o);return[i,a,f,u,l]}function ho(t,e,n,{etype:r,level:s,form:o},i){const a=Object.keys(o).filter(c=>c!=="$");return a.length?Object.entries(i).map(function([u,l]){return a.map(function(h){const p=!!(e.cardinalityInference&&n.linkIndex?.[r]?.[h]?.isSingular);try{const[g,y,m]=fo(t,n,r,s,h,u),b=ar(e,n,{etype:g,level:y,form:o[h],join:m}),_=p?b[0]:b;return{[h]:_}}catch(g){if(g instanceof fe)return{[h]:p?void 0:[]};throw g}}).reduce(function(h,p){return{...h,...p}},l)}):Object.values(i)}function po(t,e,n){return n==="string"?Js(t,e):t>e?1:-1}function Ae(t,e,n,r,s){return e===r||e==null&&r==null?Ws(t,n):r==null?1:e==null?-1:po(e,r,s)}function Ye([t,e],[n,r],s){return Ae(t,e,n,r,s)}function Et(t){return t==null?t:new Date(t).getTime()}function yo(t,e,n,r){const[s,o,i,a]=t,c=n==="desc"?1:-1;if(e["forward-identity"]?.[2]==="id")return Ye(r,[s,a],null)===c;const[u,l]=r,f=e["checked-data-type"],d=f==="date"?Et(l):l,h=f==="date"?Et(i):i;return Ye([u,d],[s,h],f)===c}function go(t,e){const n=e[1];return t.getAttr(n)}function mo(t,e,n){const r=Object.keys(n)[0];return A(t,e,r)}function bo(t,e,n,r){if(n)return go(t,n);if(r)return mo(t,e,r)}function _o(t,e,n){if(!Array.isArray(n.fields))return Ms(t,e);const r=new Map;for(const s of n.fields){const o=A(t,e,s),i=o?.["forward-identity"]?.[2];i&&Ht(o)&&r.set(i,o)}if(!r.has("id")){const s=A(t,e,"id"),o=s?.["forward-identity"]?.[2];o&&r.set(o,s)}return r}function To(t,e,{etype:n,pageInfo:r,dq:s,form:o}){const i=o?.$?.order,a=ir(o),c=wo(o);let u=Us(t,s);const l=r?.["start-cursor"],f=bo(e,n,l,i);if(f&&f?.["forward-identity"]?.[2]!=="id"){const p=f["checked-data-type"]==="date",g=f.id;u=u.map(([y])=>{let m=t.eav.get(y)?.get(g)?.values()?.next()?.value?.[2];return p&&(m=Et(m)),[y,m]})}u.sort(c==="asc"?function(g,y){return Ye(g,y,f?.["checked-data-type"])}:function(g,y){return Ye(y,g,f?.["checked-data-type"])});let d={};const h=_o(e,n,s);for(const p of u){const[g]=p;if(d[g]||!a&&l&&f&&yo(l,f,c,p))continue;const y=Es(t,h,g);y&&(d[g]=y)}return d}function wo(t){const e=t.$?.order;return e&&e[Object.keys(e)[0]]||"asc"}function ir(t){const e=t.$?.offset,n=t.$?.before,r=t.$?.after;return!e&&!n&&!r}function vo(t,e,{etype:n,level:r,form:s,join:o,pageInfo:i}){if(!ir(s)&&(!i||!i["start-cursor"]))return[];const a=so(uo(e,n,r,s.$?.where),o),c=lo(nt,n,r),u=s.$?.fields,l=To(t,e,{etype:n,pageInfo:i,form:s,dq:{where:a,find:c,fields:u}}),f=s.$?.limit||s.$?.first||s.$?.last;if(f!=null){r>0&&console.warn("WARNING: Limits in child queries are only run client-side. Data returned from the server will not have a limit.");const d=Object.entries(l);return d.length<=f?l:Object.fromEntries(d.slice(0,f))}return l}function So(t,e,n){try{return vo(t,e,n)}catch(r){if(r instanceof fe)return{};throw r}}function ar(t,e,n){const r=So(t,e,n);return ho(nt,t,e,n,r)}function Ao(t){const e={};for(const[n,r]of Object.entries(t))e[n]={startCursor:r["start-cursor"],endCursor:r["end-cursor"],hasNextPage:r["has-next-page?"],hasPreviousPage:r["has-previous-page?"]};return e}function cr({store:t,attrsStore:e,pageInfo:n,aggregate:r},s){const i={data:Object.keys(s).reduce(function(c,u){return r?.[u]||u==="$$ruleParams"||(c[u]=ar(t,e,{etype:u,form:s[u],level:0,pageInfo:n?.[u]})),c},{})};return n&&(i.pageInfo=Ao(n)),r&&(i.aggregate=r),i}function Co(){const e={__etype:1,__ops:1,create:1,update:1,link:1,unlink:1,delete:1,merge:1,ruleParams:1};return new Set(Object.keys(e))}const Eo=Co();function Ve(t,e,n){const r={__etype:t,__ops:n};return new Proxy(r,{get:(s,o)=>{if(o==="__ops")return n;if(o==="__etype")return t;if(Eo.has(o))return(i,a)=>Ve(t,e,[...n,a?[o,t,e,i,a]:[o,t,e,i]])}})}function Mo(t,e){return`lookup__${t}__${JSON.stringify(e)}`}function Ze(t){return t.startsWith("lookup__")}function Mt(t){const[e,n,...r]=t.split("__");return[n,JSON.parse(r.join("__"))]}function Oo(t){return new Proxy({__etype:t},{get(e,n){if(n==="lookup")return(s,o)=>Ve(t,Mt(Mo(s,o)),[]);if(n==="__etype")return t;const r=n;return Ze(r)?Ve(t,Mt(r),[]):Ve(t,r,[])}})}function ur(){return new Proxy({},{get(t,e){return Oo(e)}})}ur();function ko(t){return t.__ops}function Io(t,e){const{attrIdMap:n,refSwapAttrIds:r}=t,s=[];for(const i of e){const a=n[i];if(a)s.push(a);else if(Array.isArray(i)&&i.length==2&&n[i[0]]){const[c,u]=i;s.push([n[c],u])}else s.push(i)}const[o]=e;if((o==="add-triple"||o==="retract-triple")&&r.has(e[2])){const i=s[1];s[1]=s[3],s[3]=i}return s}function xo(t){if(Array.isArray(t))return t;const e=Object.entries(t);if(e.length!==1)throw new Error("lookup must be an object with a single unique attr and value.");return e[0]}function Po(t,e,n){return n.indexOf(".")!==-1&&!A(t,e,n)}function Ot(t){const[e,n,...r]=t.split(".");if(r.length>0||n!=="id")throw new Error(`${t} is not a valid lookup attribute.`);return e}function $o(t,e,n){if(!Po(t,e,n))return A(t,e,n);const r=Ot(n),s=A(t,e,r)||ie(t,e,r);if(s&&s["value-type"]!=="ref")throw new Error(`${n} does not reference a valid link attribute.`);return s}function kt(t){return typeof t=="string"&&!Ze(t)?null:typeof t=="string"&&Ze(t)?Mt(t):xo(t)}function $(t,e,n){const r=kt(n);if(r===null)return n;const[s,o]=r,i=$o(t,e,s);if(!i||!i["unique?"])throw new Error(`${s} is not a unique attribute.`);return[i.id,o]}function lr(t,e,n,r){const s=$(t,e,n);return Array.isArray(s)?[["add-triple",s,A(t,e,"id")?.id,s]].concat(r):r}function Do({attrsStore:t},[e,n,r]){const s=Object.entries(r).flatMap(([o,i])=>{const a=Array.isArray(i)?i:[i],c=A(t,e,o),u=ie(t,e,o);return a.map(l=>c?["add-triple",$(t,e,n),c.id,$(t,c["reverse-identity"][1],l)]:["add-triple",$(t,u["forward-identity"][1],l),u?.id,$(t,e,n)])});return lr(t,e,n,s)}function jo({attrsStore:t},[e,n,r]){const s=Object.entries(r).flatMap(([o,i])=>{const a=Array.isArray(i)?i:[i],c=A(t,e,o),u=ie(t,e,o);return a.map(l=>c?["retract-triple",$(t,e,n),c.id,$(t,c["reverse-identity"][1],l)]:["retract-triple",$(t,u["forward-identity"][1],l),u.id,$(t,e,n)])});return lr(t,e,n,s)}function Ro(t,e,n,r){if(Array.isArray(r)){const[s,o]=r;for(const i of t||[]){const a=i?.aev.get(s);if(a){for(const[c,u,l]of P(a,2))if(l===o)return!0}}}else for(const s of t||[]){const o=s?.eav.get(r);if(o){for(const i of o.keys())if(e.getAttr(i)?.["forward-identity"][1]==n)return!0}}return!1}function dr({stores:t,attrsStore:e},[n,r,s,o]){return o?.upsert===!1?{mode:"update"}:o?.upsert===!0?null:Ro(t,e,n,r)?{mode:"update"}:null}function Lo(t,e){const{attrsStore:n}=t,[r,s,o,i]=e,a=Bt(o),c=$(n,r,s);return[["id",c]].concat(Object.entries(a)).map(([l,f])=>{const d=A(n,r,l);return d["checked-data-type"]==="date"&&t.useDateObjects&&(f=tt(f)),["add-triple",c,d.id,f,{mode:"create"}]})}function Uo(t,e){const{attrsStore:n}=t,[r,s,o,i]=e,a=Bt(o),c=$(n,r,s),u=dr(t,[r,c,o,i]);return[["id",c]].concat(Object.entries(a)).map(([f,d])=>{const h=A(n,r,f);return h["checked-data-type"]==="date"&&t.useDateObjects&&(d=tt(d)),["add-triple",c,h.id,d,...u?[u]:[]]})}function zo({attrsStore:t},[e,n]){return[["delete-entity",$(t,e,n),e]]}function Fo(t,e){const{attrsStore:n}=t,[r,s,o,i]=e,a=Bt(o),c=$(n,r,s),u=dr(t,[r,c,o,i]),l=Object.entries(a).map(([d,h])=>{const p=A(n,r,d);return["deep-merge-triple",c,p.id,h,...u?[u]:[]]});return[["add-triple",c,A(n,r,"id").id,c,...u?[u]:[]]].concat(l)}function No({attrsStore:t},[e,n,r]){return[["rule-params",$(t,e,n),e,r]]}function qo(t){const[e,n,r,s,o]=t;if(!s)return t;const i={...s};return delete i.id,[e,n,r,i,...o?[o]:[]]}function Ko(t,e){const[n,...r]=qo(e);switch(n){case"merge":return Fo(t,r);case"create":return Lo(t,r);case"update":return Uo(t,r);case"link":return Do(t,r);case"unlink":return jo(t,r);case"delete":return zo(t,r);case"ruleParams":return No(t,r);default:throw new Error(`unsupported action ${n}`)}}function Bo(t){switch(t){case"string":case"date":case"boolean":case"number":return t;default:return}}function Vo(t,e,n){const r=t.entities[e]?.attrs?.[n];if(n==="id")return null;if(!r)throw new Error(`${e}.${n} does not exist in your schema`);const{unique:s,indexed:o}=r?.config,i=Bo(r?.valueType);return{"index?":o,"unique?":s,"checked-data-type":i}}function ze(t,e,n,r){const s=t?Vo(t,e,n):null,o=C(),a=[C(),e,n];return{id:o,"forward-identity":a,"value-type":"blob",cardinality:"one","unique?":!1,"index?":!1,isUnsynced:!0,...s||{},...r||{}}}function Ho(t,e,n){return Object.values(t.links).find(o=>o.forward.on===e&&o.forward.label===n||o.reverse.on===e&&o.reverse.label===n)}function Wo(t,e,n){const r=Ho(t,e,n);if(!r)throw new Error(`Couldn't find the link ${e}.${n} in your schema`);const{forward:s,reverse:o}=r;return{"forward-identity":[C(),s.on,s.label],"reverse-identity":[C(),o.on,o.label],cardinality:s.has==="one"?"one":"many","unique?":o.has==="one","on-delete":s.onDelete,"on-delete-reverse":o.onDelete}}function dn(t,e,n,r){const s=t?Wo(t,e,n):null,o=C(),i=[C(),e,n],a=[C(),n,e];return{id:o,"forward-identity":i,"reverse-identity":a,"value-type":"ref",cardinality:"many","unique?":!1,"index?":!1,isUnsynced:!0,...s||{},...r||{}}}const Go=new Set(["create","update","merge","link","unlink"]),Qo=new Set(["link","unlink"]),Jo=new Set(["create","update","merge"]),Yo=new Set(["link","unlink","create","update","merge","delete","ruleParams"]),It={"unique?":!0,"index?":!0},Zo={...It,cardinality:"one"};function Xo(t){const e=[],[n,r,s,o]=t;if(!Yo.has(n))return e;const i=kt(s);if(i&&e.push({etype:r,lookupPair:i}),n==="link")for(const[a,c]of Object.entries(o)){const u=Array.isArray(c)?c:[c];for(const l of u){const f=kt(l);f&&e.push({etype:r,lookupPair:f,linkLabel:a})}}return e}function ei({attrsStore:t,schema:e},n){const r=new Set,s=[],o=[];function i(d,h){return A(t,d,h)||s.find(p=>p["forward-identity"][1]===d&&p["forward-identity"][2]===h)}function a(d,h){return ie(t,d,h)||s.find(p=>p["reverse-identity"]?.[1]===d&&p["reverse-identity"]?.[2]===h)}function c(d){s.push(d),o.push(["add-attr",d]),r.add(d.id)}function u(d){d&&"isUnsynced"in d&&d.isUnsynced&&!r.has(d.id)&&(s.push(d),o.push(["add-attr",d]),r.add(d.id))}function l(d,h){return h.indexOf(".")!==-1&&!i(d,h)}function f(d,h){const p=i(d,h),g=a(d,h);u(p),u(g),!p&&!g&&c(dn(e,d,h,Zo))}for(const d of n)for(const{etype:h,lookupPair:p,linkLabel:g}of Xo(d)){const y=p[0];if(g){f(h,g);const m=i(h,g),b=a(h,g);u(m),u(b);const _=m?.["reverse-identity"]?.[1]||b?.["forward-identity"]?.[1]||g;if(l(_,y))f(_,Ot(y));else{const E=i(_,y);E||c(ze(e,_,y,It)),u(E)}}else if(l(h,y))f(h,Ot(y));else{const m=i(h,y);m||c(ze(e,h,y,It)),u(m)}}for(const d of n){const[h,p,g,y]=d;if(Go.has(h)){const m=i(p,"id");u(m),m||c(ze(e,p,"id",{"unique?":!0}));for(const b of Object.keys(y)){const _=i(p,b);if(u(_),Jo.has(h)&&(_||c(ze(e,p,b,b==="id"?{"unique?":!0}:null))),Qo.has(h)){const E=a(p,b);!_&&!E&&c(dn(e,p,b)),u(E)}}}}if(s.length){const d={...t.attrs};for(const h of s)d[h.id]=h;return[new se(d,t.linkIndex),o]}return[t,o]}function ti(t,e){const r=(Array.isArray(e)?e:[e]).flatMap(c=>ko(c)),[s,o]=ei(t,r),i={...t,attrsStore:s},a=r.flatMap(c=>Ko(i,c));return[...o,...a]}function fn(t,e){typeof requestIdleCallback>"u"?t():requestIdleCallback(t,{timeout:e})}const Me="__meta";class ni{constructor(e,n){}}class xt{currentValue;_subs=[];_persister;_merge;serialize;parse;_saveThrottleMs;_idleCallbackMaxWaitMs;_nextSave=null;_nextGc=null;_pendingSaveKeys=new Set;_loadedKeys=new Set;_loadingKeys;_objectSize;_log;onKeyLoaded;_version=0;_meta={isLoading:!0,onLoadCbs:[],value:null,error:null,attempts:0};_gcOpts;constructor(e){this._persister=e.persister,this._merge=e.merge,this.serialize=e.serialize,this.parse=e.parse,this._objectSize=e.objectSize,this._log=e.logger,this._saveThrottleMs=e.saveThrottleMs??100,this._idleCallbackMaxWaitMs=e.idleCallbackMaxWaitMs??1e3,this._gcOpts=e.gc,this.currentValue={},this._loadedKeys=new Set,this._loadingKeys={},this._initMeta(),e.preloadEntryCount&&this._preloadEntries(e.preloadEntryCount)}async _initMeta(){this._meta.loadingPromise&&await this._meta.loadingPromise;try{const e=this._persister.getItem(Me);this._meta.loadingPromise=e;const n=await e;this._meta.isLoading=!1,this._meta.error=null,this._meta.loadingPromise=null,this._meta.attempts=0;const r=this._meta.value?.objects??{},s=n??{},o=s.objects??{};this._meta.value={...s,objects:{...r,...o}}}catch(e){this._meta.error=e,this._meta.attempts++,this._meta.loadingPromise=null}}async _getMeta(){return this._meta.value?this._meta.value:this._meta.loadingPromise?(await this._meta.loadingPromise,this._meta.value):(this._initMeta(),await this._meta.loadingPromise,this._meta.value)}async _refreshMeta(){return await this._initMeta(),this._meta.value}async _preloadEntries(e){const n=await this.waitForMetaToLoad();if(!n)return;const r=Object.entries(n.objects);r.sort(([s,o],[i,a])=>a.updatedAt-o.updatedAt);for(const[s]of r.slice(0,e))this._loadKey(s)}async _getFromStorage(e){try{const n=await this._persister.getItem(e);return n&&this.parse(e,n)}catch(n){return console.error(`Unable to read from storage for key=${e}`,n),null}}async waitForKeyToLoad(e){return this._loadedKeys.has(e)?this.currentValue[e]:(await(this._loadingKeys[e]||this._loadKey(e)),this.currentValue[e])}async waitForMetaToLoad(){return this._getMeta()}unloadKey(e){this._loadedKeys.delete(e),delete this._loadingKeys[e],delete this.currentValue[e]}async _loadKey(e){if(this._loadedKeys.has(e)||e in this._loadingKeys)return;const n=this._getFromStorage(e);this._loadingKeys[e]=n;const r=await n;if(delete this._loadingKeys[e],this._loadedKeys.add(e),r){const s=this._merge(e,r,this.currentValue[e]);s&&(this.currentValue[e]=s)}this.onKeyLoaded&&this.onKeyLoaded(e)}_writeToStorage(e){const n=[],r=e?.skipGc;if(this._meta.isLoading){const f=new Promise((d,h)=>{setTimeout(()=>this._enqueuePersist(e?{...e,attempts:(e.attempts||0)+1}:{attempts:1}).then(d).catch(h),10+(e?.attempts??0)*1e3)});return n.push(f),Promise.all(n).then(d=>d.reduce((h,p)=>h+p,0))}const s=this._meta.value;if(!s)return Promise.resolve(0);const o=[],i=[];for(const f of this._pendingSaveKeys)f in this.currentValue?i.push(f):(o.push(f),delete s.objects[f]);for(const f of o){const d=this._persister.removeItem(f);n.push(d.then(()=>1)),this._loadedKeys.delete(f),this._pendingSaveKeys.delete(f)}const a=[],c=[[Me,s]],u=s.objects??{};s.objects=u;for(const f of i)if(this._loadedKeys.has(f)){const d=this.serialize(f,this.currentValue[f]);c.push([f,d]);const h=this._objectSize(d),p=u[f]??{createdAt:Date.now(),updatedAt:Date.now(),size:h};p.updatedAt=Date.now(),p.size=h,u[f]=p,this._pendingSaveKeys.delete(f)}else a.push(f);const l=this._persister.multiSet(c);n.push(l.then(()=>1));for(const f of a){const d=this._loadKey(f).then(()=>this._enqueuePersist(e));n.push(d)}return r||this.gc(),Promise.all(n).then(f=>f.reduce((d,h)=>d+h,0))}async flush(){return this._nextSave?(clearTimeout(this._nextSave),this._nextSave=null,this._writeToStorage()):void 0}async _gc(){if(!this._gcOpts)return;const e=new Set(await this._persister.getAllKeys());e.delete(Me);const n=new Set(Object.keys(this.currentValue));for(const d of Object.keys(this._loadingKeys))n.add(d);for(const d of this._loadedKeys)n.add(d);const r=await this._refreshMeta();if(!r){this._log.info("Could not gc because we were not able to load meta");return}const s=[],o={gcOpts:this._gcOpts,keys:e,sacredKeys:n,removed:[],metaRemoved:[],removedMissingCount:0,removedOldCount:0,removedThresholdCount:0,removedSizeCount:0};for(const d of e)n.has(d)||d in r.objects||(this._log.info("Lost track of key in meta",d),s.push(this._persister.removeItem(d)),o.removed.push(d),o.removedMissingCount++);const i=Date.now();for(const[d,h]of Object.entries(r.objects))!n.has(d)&&h.updatedAt<i-this._gcOpts.maxAgeMs&&(s.push(this._persister.removeItem(d)),delete r.objects[d],o.removed.push(d),o.removedOldCount++);const a=Object.entries(r.objects);a.sort(([d,h],[p,g])=>h.updatedAt-g.updatedAt);const c=a.filter(([d])=>!n.has(d));if(a.length>this._gcOpts.maxEntries)for(const[d]of c.slice(0,a.length-this._gcOpts.maxEntries))s.push(this._persister.removeItem(d)),delete r.objects[d],o.removed.push(d),o.removedThresholdCount++;const u=Object.entries(r.objects);u.sort(([d,h],[p,g])=>h.updatedAt-g.updatedAt);const l=u.filter(([d])=>!n.has(d));let f=u.reduce((d,[h,p])=>d+p.size,0);for(;f>0&&f>this._gcOpts.maxSize&&l.length;){const[[d,h]]=l.splice(0,1);f-=h.size,s.push(this._persister.removeItem(d)),delete r.objects[d],o.removed.push(d),o.removedSizeCount++}for(const d of Object.keys(r.objects))!e.has(d)&&!n.has(d)&&delete r.objects[d];return(o.removed.length||o.metaRemoved.length)&&s.push(this._enqueuePersist({skipGc:!0})),this._log.info("Completed GC",o),await Promise.all(s),o}gc(){this._nextGc||(this._nextGc=setTimeout(()=>{fn(()=>{this._nextGc=null,this._gc()},30*1e3)},1e3*60+Math.random()*500))}_enqueuePersist(e){return new Promise((n,r)=>{if(this._nextSave){n(0);return}this._nextSave=setTimeout(()=>{fn(()=>{this._nextSave=null,this._writeToStorage(e).then(n).catch(r)},this._idleCallbackMaxWaitMs)},this._saveThrottleMs)})}version(){return this._version}updateInPlace(e){this._version++;const[n,r]=Je(this.currentValue,e,{enablePatches:!0});for(const s of r){const o=s.path[0];o&&typeof o=="string"&&(this._pendingSaveKeys.add(o),this._loadedKeys.has(o)||this._loadKey(o))}this.currentValue=n,this._enqueuePersist();for(const s of this._subs)s(this.currentValue);return n}subscribe(e){return this._subs.push(e),e(this.currentValue),()=>{this._subs=this._subs.filter(n=>n!==e)}}}const ri=6,si=["kv","querySubs","syncSubs"];function oi(t){return function(n){console.error("Error in IndexedDB event",{source:t,event:n})}}async function ii(t){return new Promise(e=>{const n=indexedDB.open(t);n.onerror=r=>{e(null)},n.onsuccess=r=>{const o=r.target.result;e(o)},n.onupgradeneeded=r=>{r.target.transaction?.abort(),e(null)}})}async function ai(t,e,n){const r=typeof e=="string"?JSON.parse(e):e;if(!r)return;const s=new Set;return new Promise((o,i)=>{const a={};for(const[l,f]of Object.entries(r)){const d=typeof f=="string"?JSON.parse(f):f;if(d.lastAccessed){const p={createdAt:d.lastAccessed,updatedAt:d.lastAccessed,size:d.result?.store?.triples?.length??0};a[l]=p}const h=n.put(d,l);s.add(h)}const c={objects:a},u=n.put(c,Me);s.add(u);for(const l of s)l.onsuccess=()=>{s.delete(l),s.size===0&&o()},l.onerror=f=>{i(f)}})}async function hn(t,e,n){const r=n.put(e,t);return new Promise((s,o)=>{r.onsuccess=()=>s(),r.onerror=i=>o(i)})}async function ci(t,e){const n=await ii(`instant_${t}_5`);if(!n)return;const r=await new Promise((l,f)=>{const p=n.transaction(["kv"],"readonly").objectStore("kv").openCursor();p.onerror=y=>{f(y)};const g=[];p.onsuccess=()=>{const y=p.result;if(y){const m=y.key,b=y.value;g.push([m,b]),y.continue()}else l(g)},p.onerror=y=>{f(y)}}),s=e.transaction(["kv","querySubs"],"readwrite"),o=s.objectStore("kv"),i=s.objectStore("querySubs"),a=[],c={objects:{}};for(const[l,f]of r)if(l==="querySubs"){const d=ai(l,f,i);a.push(d)}else{const d=hn(l,f,o);a.push(d);const h={createdAt:Date.now(),updatedAt:Date.now(),size:0};c.objects[l]=h}const u=hn(Me,c,o);a.push(u),await Promise.all(a),await new Promise((l,f)=>{s.oncomplete=d=>l(d),s.onerror=d=>f(d),s.onabort=d=>f(d)})}const pn=new Map;class fr extends ni{dbName;_storeName;_appId;_prefix;_dbPromise;constructor(e,n){super(e,n),this.dbName=`instant_${e}_${ri}`,this._storeName=n,this._appId=e,this._dbPromise=this._init()}_init(){return new Promise((e,n)=>{let r=!1;const s=indexedDB.open(this.dbName,1);s.onerror=o=>{n(o)},s.onsuccess=o=>{const a=o.target.result;if(r){const c=ci(this._appId,a).catch(u=>{oi("Error upgrading store from version 5 to 6.")(u)});pn.set(this.dbName,c),c.then(()=>e(a)).catch(()=>e(a))}else{const c=pn.get(this.dbName);c?c.then(()=>e(a)).catch(()=>e(a)):e(a)}},s.onupgradeneeded=o=>{r=!0,this._upgradeStore(o)}})}_upgradeStore(e){const r=e.target.result;for(const s of si)r.objectStoreNames.contains(s)||r.createObjectStore(s)}async getItem(e){const n=await this._dbPromise;return new Promise((r,s)=>{const a=n.transaction([this._storeName],"readonly").objectStore(this._storeName).get(e);a.onerror=c=>{s(c)},a.onsuccess=c=>{a.result?r(a.result):r(null)}})}async setItem(e,n){const r=await this._dbPromise;return new Promise((s,o)=>{const c=r.transaction([this._storeName],"readwrite").objectStore(this._storeName).put(n,e);c.onerror=u=>{o(u)},c.onsuccess=u=>{s()}})}async multiSet(e){const n=await this._dbPromise;return new Promise((r,s)=>{const o=n.transaction([this._storeName],"readwrite"),i=o.objectStore(this._storeName),a=new Set;for(const[c,u]of e){const l=i.put(u,c);a.add(l)}for(const c of a)c.onerror=u=>{o.abort(),s(u)},c.onsuccess=u=>{a.delete(c),a.size===0&&r()}})}async removeItem(e){const n=await this._dbPromise;return new Promise((r,s)=>{const a=n.transaction([this._storeName],"readwrite").objectStore(this._storeName).delete(e);a.onerror=c=>{s(c)},a.onsuccess=c=>{r()}})}async getAllKeys(){const e=await this._dbPromise;return new Promise((n,r)=>{const i=e.transaction([this._storeName],"readonly").objectStore(this._storeName).getAllKeys();i.onerror=a=>{r(a)},i.onsuccess=a=>{n(i.result.filter(c=>typeof c=="string"))}})}}class hr{static async getIsOnline(){return navigator.onLine}static listen(e){const n=()=>{e(!0)},r=()=>{e(!1)};return addEventListener("online",n),addEventListener("offline",r),()=>{removeEventListener("online",n),removeEventListener("offline",r)}}}class ke extends Error{hint;constructor(e,n){super(e),this.hint=n;const r=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,r),Error.captureStackTrace&&Error.captureStackTrace(this,ke),this.name="InstantError"}get[Symbol.toStringTag](){return"InstantError"}}class rt extends ke{body;status;constructor(e){const n=e.body?.message||`API Error (${e.status})`;super(n,e.body.hint);const r=new.target.prototype;Object.setPrototypeOf&&Object.setPrototypeOf(this,r),Error.captureStackTrace&&Error.captureStackTrace(this,rt),this.name="InstantAPIError",this.status=e.status,this.body=e.body}get[Symbol.toStringTag](){return"InstantAPIError"}}async function V(t,e){const n=await fetch(t,e),r=await n.json();return n.status===200?Promise.resolve(r):Promise.reject(new rt({status:n.status,body:r}))}function ui({apiURI:t,appId:e,email:n}){return V(`${t}/runtime/auth/send_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,email:n})})}async function li({apiURI:t,appId:e,email:n,code:r,refreshToken:s}){return await V(`${t}/runtime/auth/verify_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,email:n,code:r,...s?{"refresh-token":s}:{}})})}async function di({apiURI:t,appId:e,refreshToken:n}){return await V(`${t}/runtime/auth/verify_refresh_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,"refresh-token":n})})}async function fi({apiURI:t,appId:e}){return await V(`${t}/runtime/auth/sign_in_guest`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e})})}async function yn({apiURI:t,appId:e,code:n,codeVerifier:r,refreshToken:s}){return await V(`${t}/runtime/oauth/token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:e,code:n,code_verifier:r,refresh_token:s})})}async function hi({apiURI:t,appId:e,nonce:n,idToken:r,clientName:s,refreshToken:o}){return await V(`${t}/runtime/oauth/id_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:e,nonce:n,id_token:r,client_name:s,refresh_token:o})})}async function pi({apiURI:t,appId:e,refreshToken:n}){return await V(`${t}/runtime/signout`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:e,refresh_token:n})})}async function yi({apiURI:t,appId:e,path:n,file:r,refreshToken:s,contentType:o,contentDisposition:i}){const a={app_id:e,path:n,authorization:`Bearer ${s}`,"content-type":o||r.type};return i&&(a["content-disposition"]=i),await V(`${t}/storage/upload`,{method:"PUT",headers:a,body:r})}async function gi({apiURI:t,appId:e,path:n,refreshToken:r}){const{data:s}=await V(`${t}/storage/files?app_id=${e}&filename=${encodeURIComponent(n)}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:`Bearer ${r}`}});return s}async function mi({apiURI:t,appId:e,fileName:n,refreshToken:r,metadata:s={}}){const{data:o}=await V(`${t}/storage/signed-upload-url`,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${r}`},body:JSON.stringify({app_id:e,filename:n})});return o}async function bi(t,e){return(await fetch(t,{method:"PUT",body:e,headers:{"Content-Type":e.type}})).ok}async function _i({apiURI:t,appId:e,path:n,refreshToken:r}){const{data:s}=await V(`${t}/storage/signed-download-url?app_id=${e}&filename=${encodeURIComponent(n)}`,{method:"GET",headers:{"content-type":"application/json",authorization:`Bearer ${r}`}});return s}let Gt=!1,pr=!1,yr=!1;typeof window<"u"&&typeof window.localStorage<"u"&&(Gt=!!window.localStorage.getItem("devBackend"),pr=!!window.localStorage.getItem("__instantLogging"),yr=!!window.localStorage.getItem("__devtoolLocalDash"));function gn(t,e){if(!e)return t;const n={};return e.forEach(r=>{n[r]=t[r]}),n}function Ti(t,e,n){const r={peers:{}};if(e&&"user"in e?e.user:!0){const o=gn(t.user??{},e?.keys);r.user={...o,peerId:n}}for(const o of Object.keys(t.peers??{})){const i=e?.peers===void 0,a=Array.isArray(e?.peers)&&e?.peers.includes(o);if(i||a){const c=gn(t.peers[o],e?.keys);r.peers[o]={...c,peerId:o}}}return r}function wi(t,e){if(t.isLoading!==e.isLoading||t.error!==e.error||(t.user||e.user)&&(!t.user||!e.user||!en(t.user,e.user))||!Bn(t.peers,e.peers))return!0;for(const r of Object.keys(t.peers))if(!en(t.peers[r],e.peers[r]))return!0;return!1}class mn{promise;_resolve;_reject;constructor(){this.promise=new Promise((e,n)=>{this._resolve=e,this._reject=n})}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}function gr(t,e=[]){t.forEach(n=>{const{data:r}=n,{"datalog-result":s}=r,{"join-rows":o}=s;for(const i of o)for(const a of i)e.push(a);gr(n["child-nodes"],e)})}function bn(t){const e=[];return gr(t,e),e}function _n(t){return Object.values(t.links).reduce((e,n)=>(e[n.forward.on]??={},e[n.forward.on][n.forward.label]={isForward:!0,isSingular:n.forward.has==="one",link:n},e[n.reverse.on]??={},e[n.reverse.on][n.reverse.label]={isForward:!1,isSingular:n.reverse.has==="one",link:n},e),{})}const mr="v0.22.112";function vi(t,e){return{info:t?(...n)=>console.info(...n,e()):()=>{},debug:t?(...n)=>console.debug(...n,e()):()=>{},error:t?(...n)=>console.error(...n,e()):()=>{}}}class J{valueType;required;isIndexed;config;metadata={};constructor(e,n,r,s={indexed:!1,unique:!1}){this.valueType=e,this.required=n,this.isIndexed=r,this.config=s}clientRequired(){return new J(this.valueType,!1,this.isIndexed,this.config)}optional(){return new J(this.valueType,!1,this.isIndexed,this.config)}unique(){return new J(this.valueType,this.required,this.isIndexed,{...this.config,unique:!0})}indexed(){return new J(this.valueType,this.required,!0,{...this.config,indexed:!0})}}class v extends Error{constructor(e,n){const r=n?`At path '${n}': ${e}`:e;super(r),this.name="QueryValidationError"}}const Tn=["where","order","limit","last","first","offset","after","before","fields","aggregate"],Si=t=>t.valueType||"unknown",br=(t,e,n=!1)=>{if(n||t==null)return!0;switch(e){case"string":return typeof t=="string";case"number":return typeof t=="number"&&!isNaN(t);case"boolean":return typeof t=="boolean";case"date":return t instanceof Date||typeof t=="string"||typeof t=="number";default:return!0}},Ai=(t,e,n,r,s,o,i)=>{const a=o.valueType==="json",c=(u,l,f)=>{if(!br(f,l,a))throw new v(`Invalid value for operator '${u}' on attribute '${r}' in entity '${s}'. Expected ${l}, but received: ${typeof f}`,i)};switch(t){case"in":case"$in":if(!Array.isArray(e))throw new v(`Operator '${t}' for attribute '${r}' in entity '${s}' must be an array, but received: ${typeof e}`,i);for(const u of e)c(t,n,u);break;case"$not":case"$ne":case"$gt":case"$lt":case"$gte":case"$lte":c(t,n,e);break;case"$like":case"$ilike":if(c(t,"string",e),t==="$ilike"&&!o.isIndexed)throw new v(`Operator '${t}' can only be used with indexed attributes, but '${r}' in entity '${s}' is not indexed`,i);break;case"$isNull":c(t,"boolean",e);break;default:throw new v(`Unknown operator '${t}' for attribute '${r}' in entity '${s}'`,i)}},le=(t,e,n,r,s)=>{const o=Si(n),i=n.valueType==="json";if(typeof t=="object"&&t!==null&&!Array.isArray(t)){if(i)return;const c=t;for(const[u,l]of Object.entries(c))Ai(u,l,o,e,r,n,`${s}.${u}`)}else if(!br(t,o,i))throw new v(`Invalid value for attribute '${e}' in entity '${r}'. Expected ${o}, but received: ${typeof t}`,s)},Ci=(t,e,n,r,s)=>{const o=t.split(".");if(o.length<2)throw new v(`Invalid dot notation path '${t}'. Must contain at least one dot.`,s);let i=n;for(let l=0;l<o.length-1;l++){const f=o[l],d=r.entities[i];if(!d)throw new v(`Entity '${i}' does not exist in schema while traversing dot notation path '${t}'.`,s);const h=d.links[f];if(!h){const p=Object.keys(d.links);throw new v(`Link '${f}' does not exist on entity '${i}' in dot notation path '${t}'. Available links: ${p.length>0?p.join(", "):"none"}`,s)}i=h.entityName}const a=o[o.length-1],c=r.entities[i];if(!c)throw new v(`Target entity '${i}' does not exist in schema for dot notation path '${t}'.`,s);if(a==="id"){if(typeof e=="string"&&!de(e))throw new v(`Invalid value for id field in entity '${i}'. Expected a UUID, but received: ${e}`,s);le(e,t,new J("string",!1,!0),n,s);return}const u=c.attrs[a];if(Object.keys(c.links).includes(a)){if(typeof e=="string"&&!de(e))throw new v(`Invalid value for link '${a}' in entity '${i}'. Expected a UUID, but received: ${e}`,s);le(e,t,new J("string",!1,!0),n,s);return}if(!u){const l=Object.keys(c.attrs);throw new v(`Attribute '${a}' does not exist on entity '${i}' in dot notation path '${t}'. Available attributes: ${l.length>0?l.join(", ")+", id":"id"}`,s)}le(e,t,u,n,s)},_r=(t,e,n,r)=>{for(const[s,o]of Object.entries(t)){if(s==="or"||s==="and"){if(Array.isArray(o))for(const u of o)typeof u=="object"&&u!==null&&_r(u,e,n,`${r}.${s}[${u}]`);continue}if(s==="id"){le(o,"id",new J("string",!1,!0),e,`${r}.id`);continue}if(s.includes(".")){Ci(s,o,e,n,`${r}.${s}`);continue}const i=n.entities[e];if(!i)continue;const a=i.attrs[s],c=i.links[s];if(!a&&!c){const u=Object.keys(i.attrs),l=Object.keys(i.links);throw new v(`Attribute or link '${s}' does not exist on entity '${e}'. Available attributes: ${u.length>0?u.join(", "):"none"}. Available links: ${l.length>0?l.join(", "):"none"}`,`${r}.${s}`)}if(a)le(o,s,a,e,`${r}.${s}`);else if(c){if(typeof o=="string"&&!de(o))throw new v(`Invalid value for link '${s}' in entity '${e}'. Expected a UUID, but received: ${o}`,`${r}.${s}`);const u=new J("string",!1,!0);le(o,s,u,e,`${r}.${s}`)}}},Ei=(t,e,n,r,s=0)=>{for(const i of Object.keys(t))if(!Tn.includes(i))throw new v(`Invalid query parameter '${i}' in $ object. Valid parameters are: ${Tn.join(", ")}. Found: ${i}`,r);const o=["offset","before","after","first","last"];for(const i of o)if(t[i]!==void 0&&s>0)throw new v(`'${i}' can only be used on top-level namespaces. It cannot be used in nested queries.`,r);if(t.where&&n){if(typeof t.where!="object"||t.where===null)throw new v(`'where' clause must be an object in entity '${e}', but received: ${typeof t.where}`,r?`${r}.where`:void 0);_r(t.where,e,n,r?`${r}.where`:"where")}},Tr=(t,e,n,r,s=0)=>{if(!t||typeof t!="object")throw new v(`Query part for entity '${e}' must be an object, but received: ${typeof t}`,r);for(const o of Object.keys(t))if(o!=="$"){if(n&&!(o in n.entities[e].links)){const a=Object.keys(n.entities[e].links);throw new v(`Link '${o}' does not exist on entity '${e}'. Available links: ${a.length>0?a.join(", "):"none"}`,`${r}.${o}`)}const i=t[o];if(typeof i=="object"&&i!==null){const a=n?.entities[e].links[o]?.entityName;a&&Tr(i,a,n,`${r}.${o}`,s+1)}}else{const i=t[o];if(typeof i!="object"||i===null)throw new v(`Query parameter '$' must be an object in entity '${e}', but received: ${typeof i}`,`${r}.$`);Ei(i,e,n,`${r}.$`,s)}},wn=(t,e)=>{if(typeof t!="object"||t===null)throw new v(`Query must be an object, but received: ${typeof t}${t===null?" (null)":""}`);if(Array.isArray(t))throw new v(`Query must be an object, but received: ${typeof t}`);const n=t;for(const r of Object.keys(n)){if(Array.isArray(t[r]))throw new v(`Query keys must be strings, but found key of type: ${typeof r}`,r);if(typeof r!="string")throw new v(`Query keys must be strings, but found key of type: ${typeof r}`,r);if(r!=="$$ruleParams"){if(e&&!e.entities[r]){const s=Object.keys(e.entities);throw new v(`Entity '${r}' does not exist in schema. Available entities: ${s.length>0?s.join(", "):"none"}`,r)}Tr(n[r],r,e,r,0)}}},vn=t=>typeof t!="string"?!1:Ze(t)?!0:de(t);class L extends Error{constructor(e){super(e),this.name="TransactionValidationError"}}const wr=t=>t.length>0?t.join(", "):"none",Mi=(t,e)=>new L(`Entity '${t}' does not exist in schema. Available entities: ${wr(e)}`),Oi={string:t=>typeof t=="string",number:t=>typeof t=="number"&&!isNaN(t),boolean:t=>typeof t=="boolean",date:t=>t instanceof Date||typeof t=="string"||typeof t=="number",json:()=>!0},ki=(t,e)=>t==null?!0:Oi[e.valueType]?.(t)??!1,vr=(t,e)=>{const n=e.entities[t];if(!n)throw Mi(t,Object.keys(e.entities));return n},lt=(t,e,n)=>{const r=vr(t,n);if(typeof e!="object"||e===null)throw new L(`Arguments for data operation on entity '${t}' must be an object, but received: ${typeof e}`);for(const[s,o]of Object.entries(e)){if(s==="id")continue;const i=r.attrs[s];if(i&&!ki(o,i))throw new L(`Invalid value for attribute '${s}' in entity '${t}'. Expected ${i.valueType}, but received: ${typeof o}`)}},Sn=(t,e,n)=>{const r=vr(t,n);if(typeof e!="object"||e===null)throw new L(`Arguments for link operation on entity '${t}' must be an object, but received: ${typeof e}`);for(const[s,o]of Object.entries(e)){if(!r.links[s]){const a=Object.keys(r.links);throw new L(`Link '${s}' does not exist on entity '${t}'. Available links: ${wr(a)}`)}if(o!=null){if(Array.isArray(o)){for(const a of o)if(!vn(a))throw new L(`Invalid entity ID in link '${s}' for entity '${t}'. Expected a UUID or a lookup, but received: ${a}`)}else if(!vn(o))throw new L(`Invalid UUID in link '${s}' for entity '${t}'. Expected a UUID, but received: ${o}`)}}},Ii={create:lt,update:lt,merge:lt,link:Sn,unlink:Sn,delete:()=>{}},xi=(t,e)=>{if(!e)return;const[n,r,s,o]=t;if(!Array.isArray(s)&&!de(s))throw new L(`Invalid id for entity '${r}'. Expected a UUID, but received: ${s}`);if(typeof r!="string")throw new L(`Entity name must be a string, but received: ${typeof r}`);const i=Ii[n];i&&o!==void 0&&i(r,o,e)},Pi=(t,e)=>{const n=Array.isArray(t)?t:[t];for(const r of n){if(!r||typeof r!="object")throw new L(`Transaction chunk must be an object, but received: ${typeof r}`);if(!Array.isArray(r.__ops))throw new L(`Transaction chunk must have __ops array, but received: ${typeof r.__ops}`);for(const s of r.__ops){if(!Array.isArray(s))throw new L(`Transaction operation must be an array, but received: ${typeof s}`);xi(s,e)}}};let Sr=0;class An{type="ws";conn;id;onopen;onmessage;onclose;onerror;constructor(e){this.id=`${this.type}_${Sr++}`,this.conn=new WebSocket(e),this.conn.onopen=n=>{this.onopen&&this.onopen({target:this})},this.conn.onmessage=n=>{this.onmessage&&this.onmessage({target:this,message:JSON.parse(n.data.toString())})},this.conn.onclose=n=>{this.onclose&&this.onclose({target:this})},this.conn.onerror=n=>{this.onerror&&this.onerror({target:this})}}close(){this.conn.close()}isOpen(){return this.conn.readyState===(WebSocket.OPEN??1)}isConnecting(){return this.conn.readyState===(WebSocket.CONNECTING??0)}send(e){return this.conn.send(JSON.stringify(e))}}class $i{type="sse";initParams=null;sendQueue=[];sendPromise;closeFired=!1;sseInitTimeout=void 0;ES;conn;url;id;onopen;onmessage;onclose;onerror;constructor(e,n){this.id=`${this.type}_${Sr++}`,this.url=n,this.ES=e,this.conn=new e(n),this.sseInitTimeout=setTimeout(()=>{this.initParams||this.handleError()},1e4),this.conn.onmessage=r=>{const s=JSON.parse(r.data);if(Array.isArray(s))for(const o of s)this.handleMessage(o);else this.handleMessage(s)},this.conn.onerror=r=>{this.handleError()}}handleMessage(e){if(e.op==="sse-init"){this.initParams={machineId:e["machine-id"],sessionId:e["session-id"],sseToken:e["sse-token"]},this.onopen&&this.onopen({target:this}),clearTimeout(this.sseInitTimeout);return}this.onmessage&&this.onmessage({target:this,message:e})}handleError(){try{this.onerror&&this.onerror({target:this})}finally{this.handleClose()}}handleClose(){this.conn.close(),this.onclose&&!this.closeFired&&(this.closeFired=!0,this.onclose({target:this}))}async postMessages(e){try{(await fetch(this.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({machine_id:this.initParams?.machineId,session_id:this.initParams?.sessionId,sse_token:this.initParams?.sseToken,messages:e})})).ok||this.handleError()}catch{this.handleError()}}async flushQueue(){if(this.sendPromise||!this.sendQueue.length)return;const e=this.sendQueue;this.sendQueue=[];const n=this.postMessages(e);this.sendPromise=n,n.then(()=>{this.sendPromise=null,this.flushQueue()})}send(e){if(!this.isOpen()||!this.initParams)throw this.isConnecting()?new Error("Failed to execute 'send' on 'EventSource': Still in CONNECTING state."):this.conn.readyState===this.ES.CLOSED?new Error("EventSource is already in CLOSING or CLOSED state."):new Error("EventSource is in invalid state.");this.sendQueue.push(e),this.flushQueue()}isOpen(){return this.conn.readyState===this.ES.OPEN&&this.initParams!==null}isConnecting(){return this.conn.readyState===this.ES.CONNECTING||this.conn.readyState===this.ES.OPEN&&this.initParams===null}close(){this.handleClose()}}function Di(t,e){const n=t.values;if(n){const r=Jn(n.attrsStore,null);if(r){for(const s of n.entities||[])s.store.useDateObjects=e,s.store=Qn(r,s.store);n.attrsStore=r}}return t}function ji(t,e){if(e.values){const n=[];for(const r of e.values?.entities){const s=Gn(r.store);n.push({...r,store:s})}return{...e,values:{attrsStore:e.values.attrsStore.toJSON(),entities:n}}}else return e}function Ri(t,e,n){const r=e?.state?.txId,s=n?.state?.txId;return r&&(!s||r>s)?e:s&&(!r||s>r)?n:e||n}function dt(t,e,n){return cr({store:e,attrsStore:n,pageInfo:null,aggregate:null},t.query).data[t.table][0]}function Cn(t,e,n,r){const s=A(n,t.table,"id")?.id;if(!s)return-1;const o=me(e.eav,[r,s,r]);return o?o[3]:-1}function En(t,e,n){for(const{action:r,triple:s}of n)switch(r){case"added":Xn(t,e,s);break;case"removed":Yn(t,e,s);break}}function Li(t,e,n){const r={};for(const{action:s,triple:o}of n){const[i,a,c]=o,u=e.getAttr(a)?.["forward-identity"]?.[2];if(!u)continue;const l=r[i]??{};r[i]=l;const f=l[u]??{};switch(s){case"added":f.newValue=c;break;case"removed":f.oldValue===void 0&&(f.oldValue=c);break}l[u]=f}for(const[s,o]of Object.entries(r))for(const[i,{oldValue:a,newValue:c}]of Object.entries(o))a===c&&delete o[i];return r}function Fe(t,e){return{[t.table]:e.map(n=>n.entity)}}function Ui(t,e){if(t.orderFieldType)return t.orderFieldType;const n=t.orderField==="serverCreatedAt"?"number":A(e(),t.table,t.orderField)?.["checked-data-type"];return t.orderFieldType=n,n}function zi(t,e,n){const r=e;if(t.orderField==="serverCreatedAt"){n.sort(t.orderDirection==="asc"?function(i,a){return Ae(i.entity.id,i.serverCreatedAt,a.entity.id,a.serverCreatedAt,r)}:function(i,a){return Ae(a.entity.id,a.serverCreatedAt,i.entity.id,i.serverCreatedAt,r)});return}const s=t.orderField;n.sort(t.orderDirection==="asc"?function(i,a){return Ae(i.entity.id,i.entity[s],a.entity.id,a.entity[s],r)}:function(i,a){return Ae(a.entity.id,a.entity[s],i.entity.id,i.entity[s],r)})}var te;(function(t){t.InitialSyncBatch="InitialSyncBatch",t.InitialSyncComplete="InitialSyncComplete",t.LoadFromStorage="LoadFromStorage",t.SyncTransaction="SyncTransaction",t.Error="Error"})(te||(te={}));class Fi{trySend;subs;callbacks={};config;idToHash={};log;createStore;getAttrs;constructor(e,n,r,s,o,i){this.trySend=e,this.config=r,this.log=s,this.createStore=o,this.getAttrs=i,this.subs=new xt({persister:n,merge:Ri,serialize:ji,parse:(a,c)=>Di(c,this.config.useDateObjects),objectSize:a=>a.values?.entities.length||0,logger:s,gc:{maxAgeMs:1e3*60*60*24*7*52,maxEntries:1e3,maxSize:1e6}})}beforeUnload(){this.subs.flush()}subscribe(e,n){const r=O(e);return this.callbacks[r]=this.callbacks[r]||[],this.callbacks[r].push(n),this.initSubscription(e,r,n),s=>{this.unsubscribe(r,n,s?.keepSubscription)}}unsubscribe(e,n,r){const s=(this.callbacks[e]||[]).filter(o=>o!==n);if(this.callbacks[e]=s,!s.length){delete this.callbacks[e];const o=this.subs.currentValue[e];o?.state&&this.clearSubscriptionData(o.state.subscriptionId,!!r),r||this.subs.updateInPlace(i=>{delete i[e]})}}sendStart(e){this.trySend(C(),{op:"start-sync",q:e})}sendResync(e,n,r){this.idToHash[n.subscriptionId]=e.hash,this.trySend(n.subscriptionId,{op:"resync-table","subscription-id":n.subscriptionId,"tx-id":r,token:n.token})}sendRemove(e,n){this.trySend(C(),{op:"remove-sync","subscription-id":e.subscriptionId,"keep-subscription":n})}async initSubscription(e,n,r){await this.subs.waitForKeyToLoad(n);const s=this.subs.currentValue[n];if(s&&s.state&&s.state.txId){this.sendResync(s,s.state,s.state.txId),s.values?.entities&&r&&r({type:te.LoadFromStorage,data:Fe(s,s.values?.entities)});return}const o=Object.keys(e)[0],i=e[o]?.$?.order||{serverCreatedAt:"asc"},[a,c]=Object.entries(i)[0];this.subs.updateInPlace(u=>{u[n]={query:e,hash:n,table:o,orderDirection:c,orderField:a,createdAt:Date.now(),updatedAt:Date.now()}}),this.sendStart(e)}async flushPending(){for(const e of Object.keys(this.callbacks)){await this.subs.waitForKeyToLoad(e);const n=this.subs.currentValue[e];n?await this.initSubscription(n.query,n.hash):this.log.error("Missing sub for hash in flushPending",e)}}onStartSyncOk(e){const n=e["subscription-id"],r=e.q,s=O(r);this.idToHash[n]=s,this.subs.updateInPlace(o=>{const i=o[s];if(!i)return this.log.error("Missing sub for hash",s,"subscription-id",n,"query",r),o;i.state={subscriptionId:n,token:e.token}})}notifyCbs(e,n){for(const r of this.callbacks[e]||[])r(n)}onSyncLoadBatch(e){const n=e["subscription-id"],r=e["join-rows"],s=this.idToHash[n];if(!s){this.log.error("Missing hash for subscription",e);return}const o=[],i=this.subs.currentValue[s];if(!i){this.log.error("Missing sub for hash",s,e);return}const a=i.values??{entities:[],attrsStore:this.getAttrs()};i.values=a;const c=a.entities;for(const u of r){const l=this.createStore(u),f=dt(i,l,a.attrsStore);c.push({store:l,entity:f,serverCreatedAt:Cn(i,l,a.attrsStore,f.id)}),o.push(f)}this.subs.updateInPlace(u=>{u[s]=i,u[s].updatedAt=Date.now()}),i.values&&this.notifyCbs(s,{type:te.InitialSyncBatch,data:Fe(i,i.values.entities),batch:o})}onSyncInitFinish(e){const n=e["subscription-id"],r=this.idToHash[n];if(!r){this.log.error("Missing hash for subscription",e);return}this.subs.updateInPlace(o=>{const i=o[r];if(!i){this.log.error("Missing sub for hash",r,e);return}const a=i.state;if(!a)return this.log.error("Sub never set init, missing result",i,e),o;a.txId=e["tx-id"],i.updatedAt=Date.now()});const s=this.subs.currentValue[r];s&&this.notifyCbs(r,{type:te.InitialSyncComplete,data:Fe(s,s.values?.entities||[])})}onSyncUpdateTriples(e){const n=e["subscription-id"],r=this.idToHash[n];if(!r){this.log.error("Missing hash for subscription",e);return}const s=this.subs.currentValue[r];if(!s){this.log.error("Missing sub for hash",r,e);return}const o=s.state;if(!o){this.log.error("Missing state for sub",s,e);return}for(const i of e.txes){if(o.txId&&o.txId>=i["tx-id"])continue;o.txId=i["tx-id"];const a=[],c={};for(const g of i.changes){const y=c[g.triple[0]]??[];c[g.triple[0]]=y,y.push(g)}const u=s.values??{entities:[],attrsStore:this.getAttrs()},l=u.entities;s.values=u;const f=[];e:for(const[g,y]of Object.entries(c))for(let m=0;m<l.length;m++){const b=l[m];if(ms(b.store,g)){En(b.store,u.attrsStore,y);const _=dt(s,b.store,u.attrsStore),E=Li(b.store,u.attrsStore,y)[g];_?(f.push({oldEntity:b.entity,newEntity:_,changedFields:E||{}}),b.entity=_):a.push(m),delete c[g];continue e}}const d=[];for(const[g,y]of Object.entries(c)){const m=this.createStore([]);En(m,u.attrsStore,y);const b=dt(s,m,u.attrsStore);if(!b){this.log.error("No entity found after applying change",{sub:s,changes:y,store:m});continue}l.push({store:m,entity:b,serverCreatedAt:Cn(s,m,u.attrsStore,b.id)}),d.push(b)}const h=[];for(const g of a.sort().reverse())h.push(l[g].entity),l.splice(g,1);const p=Ui(s,this.getAttrs);zi(s,p,l),this.notifyCbs(r,{type:te.SyncTransaction,data:Fe(s,s.values?.entities),added:d,removed:h,updated:f})}this.subs.updateInPlace(i=>{i[r]=s,i[r].updatedAt=Date.now()})}clearSubscriptionData(e,n){const r=this.idToHash[e];if(r){delete this.idToHash[e];const s=this.subs.currentValue[r];if(s.state&&this.sendRemove(s.state,n),n?this.subs.unloadKey(r):this.subs.updateInPlace(o=>{delete o[r]}),s)return s}}onStartSyncError(e){const n=O(e["original-event"].q),r={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa.",status:e.status,type:e.type,hint:e.hint},s=Object.keys(e["original-event"].q)[0];this.notifyCbs(n,{type:te.Error,data:{[s]:[]},error:r})}onResyncError(e){const n=e["original-event"]["subscription-id"],r=this.clearSubscriptionData(n,!1);r&&this.initSubscription(r.query,r.hash)}}const Q={CONNECTING:"connecting",OPENED:"opened",AUTHENTICATED:"authenticated",CLOSED:"closed",ERRORED:"errored"},Ni=3e4,qi=3e4,Ki=200,Bi=1e3*60,Vi={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"},ft="_instant_oauth_redirect",_e="currentUser";function Hi({transportType:t,appId:e,apiURI:n,wsURI:r,EventSourceImpl:s}){if(!s)return new An(`${r}?app_id=${e}`);switch(t){case"ws":return new An(`${r}?app_id=${e}`);case"sse":return new $i(s,`${n}/runtime/sse?app_id=${e}`);default:throw new Error("Unknown transport type "+t)}}function Wi(){return typeof window<"u"||typeof chrome<"u"}const Mn={"set-presence":!0,"set-presence-ok":!0,"refresh-presence":!0,"patch-presence":!0};function Gi(t,e){const n=typeof t=="string"?JSON.parse(t):t;if(n?.result?.store){const r=Jn(n.result.attrsStore,n.result.store);if(r){const s=n.result.store;n.result.store=Qn(r,{...s,useDateObjects:e}),n.result.attrsStore=r}}return n}function Qi(t,e){const{result:n,...r}=e,s=r;if(n){const o={...n,store:Gn(n.store),attrsStore:n.attrsStore.toJSON()};s.result=o}return s}function Ji(t,e){return t==="pendingMutations"?new Map(typeof e=="string"?JSON.parse(e):e):e}function Yi(t,e){return t==="pendingMutations"?[...e.entries()]:e}function Zi(t,e,n){const r=e?.result,s=n?.result;return r&&!s&&n&&(n.result=r),n||e}function ht(t){return[...t].sort((e,n)=>{const[r,s]=e,[o,i]=n,a=s.order||0,c=i.order||0;return a==c?r<o?-1:r>o?1:0:a-c})}class Xi{attrs;_isOnline=!0;_isShutdown=!1;status=Q.CONNECTING;querySubs;kv;_syncTable;queryCbs={};queryOnceDfds={};authCbs=[];attrsCbs=[];mutationErrorCbs=[];connectionStatusCbs=[];config;mutationDeferredStore=new Map;_reconnectTimeoutId=null;_reconnectTimeoutMs=0;_transport;_transportType="ws";_EventSource;_wsOk=null;_localIdPromises={};_errorMessage=null;_oauthCallbackResponse=null;_linkIndex=null;_broadcastChannel;_rooms={};_roomsPendingLeave={};_presence={};_broadcastQueue=[];_broadcastSubs={};_currentUserCached={isLoading:!0,error:void 0,user:void 0};_beforeUnloadCbs=[];_dataForQueryCache={};_log;_pendingTxCleanupTimeout;_pendingMutationCleanupThreshold;_inFlightMutationEventIds=new Set;constructor(e,n=fr,r=hr,s,o){if(this._EventSource=o,this.config={...Vi,...e},this.queryCacheLimit=this.config.queryCacheLimit??10,this._pendingTxCleanupTimeout=this.config.pendingTxCleanupTimeout??qi,this._pendingMutationCleanupThreshold=this.config.pendingMutationCleanupThreshold??Ki,this._log=vi(e.verbose||Gt||pr,()=>this._reactorStats()),this.versions={...s||{},"@instantdb/core":mr},this.config.schema&&(this._linkIndex=_n(this.config.schema)),!!Wi()){if(!e.appId)throw new Error("Instant must be initialized with an appId.");if(!de(e.appId))throw new Error(`Instant must be initialized with a valid appId. \`${e.appId}\` is not a valid uuid.`);typeof BroadcastChannel=="function"&&(this._broadcastChannel=new BroadcastChannel("@instantdb"),this._broadcastChannel.addEventListener("message",async i=>{try{if(i.data?.type==="auth"){const a=await this.getCurrentUser();this.updateUser(a.user)}}catch(a){this._log.error("[error] handle broadcast channel",a)}})),this._initStorage(n),this._syncTable=new Fi(this._trySendAuthed.bind(this),new n(this.config.appId,"syncSubs"),{useDateObjects:this.config.useDateObjects},this._log,i=>Se(this.ensureAttrs(),i,this.config.enableCardinalityInference,this.config.useDateObjects),()=>this.ensureAttrs()),this._oauthCallbackResponse=this._oauthLoginInit(),this.getCurrentUser().then(i=>{this.syncUserToEndpoint(i.user)}),setInterval(async()=>{const i=await this.getCurrentUser();this.syncUserToEndpoint(i.user)},Bi),r.getIsOnline().then(i=>{this._isOnline=i,this._startSocket(),r.listen(a=>{a!==this._isOnline&&(this._log.info("[network] online =",a),this._isOnline=a,this._isOnline?this._startSocket():(this._log.info("Changing status from",this.status,"to",Q.CLOSED),this._setStatus(Q.CLOSED)))})}),typeof addEventListener<"u"&&(this._beforeUnload=this._beforeUnload.bind(this),addEventListener("beforeunload",this._beforeUnload))}}ensureAttrs(){if(!this.attrs)throw new Error("attrs have not loaded.");return this.attrs}updateSchema(e){this.config={...this.config,schema:e,cardinalityInference:!!e},this._linkIndex=e?_n(this.config.schema):null}_reactorStats(){return{inFlightMutationCount:this._inFlightMutationEventIds.size,storedMutationCount:this._pendingMutations().size,transportType:this._transportType}}_onQuerySubLoaded(e){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyOne(e))}_initStorage(e){this.querySubs=new xt({persister:new e(this.config.appId,"querySubs"),merge:Zi,serialize:Qi,parse:(n,r)=>Gi(r,this.config.useDateObjects),objectSize:n=>n?.result?.store?.triples?.length??0,logger:this._log,preloadEntryCount:10,gc:{maxAgeMs:1e3*60*60*24*7*52,maxEntries:1e3,maxSize:1e6}}),this.querySubs.onKeyLoaded=n=>this._onQuerySubLoaded(n),this.kv=new xt({persister:new e(this.config.appId,"kv"),merge:this._onMergeKv,serialize:Yi,parse:Ji,objectSize:()=>0,logger:this._log,saveThrottleMs:100,idleCallbackMaxWaitMs:100,gc:null}),this.kv.onKeyLoaded=n=>{n==="pendingMutations"&&this.notifyAll()},this.kv.waitForKeyToLoad("pendingMutations"),this.kv.waitForKeyToLoad(_e),this._beforeUnloadCbs.push(()=>{this.kv.flush(),this.querySubs.flush()})}_beforeUnload(){for(const e of this._beforeUnloadCbs)e();this._syncTable.beforeUnload()}_finishTransaction(e,n,r){const s=this.mutationDeferredStore.get(n);this.mutationDeferredStore.delete(n);const o=e!=="error"&&e!=="timeout";if(!s&&!o&&console.error("Mutation failed",{status:e,eventId:n,...r}),!!s)if(o)s.resolve({status:e,eventId:n});else if(r?.type){const{status:i,...a}=r;s.reject(new rt({body:a,status:i??0}))}else s.reject(new ke(r?.message||"Unknown error",r?.hint))}_setStatus(e,n){this.status=e,this._errorMessage=n,this.notifyConnectionStatusSubs(e)}_onMergeKv=(e,n,r)=>{if(e==="pendingMutations"){const s=n?.entries()??[],o=r?.entries()??[],i=new Map([...s,...o]);return(n?this._rewriteMutationsSorted(this.attrs,n):[]).forEach(([c,u])=>{!r?.pendingMutations?.has(c)&&!u["tx-id"]&&this._sendMutation(c,u)}),i}else return r||n};_flushEnqueuedRoomData(e){const n=this._presence[e]?.result?.user,r=this._broadcastQueue[e];if(this._broadcastQueue[e]=[],n&&this._trySetPresence(e,n),r)for(const s of r){const{topic:o,roomType:i,data:a}=s;this._tryBroadcast(e,i,o,a)}}_addQueryData(e,n,r){if(!this.attrs)throw new Error("Attrs in reactor have not been set");const s=O(e),o=this.ensureAttrs(),i=Se(this.attrs,n.triples,r,this.config.useDateObjects);this.querySubs.updateInPlace(a=>{a[s]={result:{store:i,attrsStore:o,pageInfo:n.pageInfo,processedTxId:void 0,isExternal:!0},q:e}}),this._cleanupPendingMutationsQueries(),this.notifyOne(s),this.notifyOneQueryOnce(s),this._cleanupPendingMutationsTimeout()}_handleReceive(e,n){const r=!!this.config.schema&&("cardinalityInference"in this.config?!!this.config.cardinalityInference:!0);switch(Mn[n.op]||this._log.info("[receive]",e,n.op,n),n.op){case"init-ok":{this._setStatus(Q.AUTHENTICATED),this._reconnectTimeoutMs=0,this._setAttrs(n.attrs),this._flushPendingMessages(),this._sessionId=n["session-id"];for(const i of Object.keys(this._rooms)){const a=this._presence[i]?.result?.user;this._tryJoinRoom(i,a)}break}case"add-query-exists":{this.notifyOneQueryOnce(O(n.q));break}case"add-query-ok":{const{q:i,result:a}=n,c=O(i);if(!this._hasQueryListeners()&&!this.querySubs.currentValue[c])break;const u=a?.[0]?.data?.["page-info"],l=a?.[0]?.data?.aggregate,f=bn(a),d=this.ensureAttrs(),h=Se(d,f,r,this.config.useDateObjects);this.querySubs.updateInPlace(p=>{if(!p[c]){this._log.info("Missing value in querySubs",{hash:c,q:i});return}p[c].result={store:h,attrsStore:d,pageInfo:u,aggregate:l,processedTxId:n["processed-tx-id"]}}),this._cleanupPendingMutationsQueries(),this.notifyOne(c),this.notifyOneQueryOnce(c),this._cleanupPendingMutationsTimeout();break}case"start-sync-ok":{this._syncTable.onStartSyncOk(n);break}case"sync-load-batch":{this._syncTable.onSyncLoadBatch(n);break}case"sync-init-finish":{this._syncTable.onSyncInitFinish(n);break}case"sync-update-triples":{this._syncTable.onSyncUpdateTriples(n);break}case"refresh-ok":{const{computations:i,attrs:a}=n,c=n["processed-tx-id"];a&&this._setAttrs(a),this._cleanupPendingMutationsTimeout();const u=this._rewriteMutations(this.ensureAttrs(),this._pendingMutations(),c);u!==this._pendingMutations()&&this.kv.updateInPlace(d=>{d.pendingMutations=u});const l=ht(u.entries()),f=i.map(d=>{const h=d["instaql-query"],p=d["instaql-result"],g=O(h),y=bn(p),m=this.ensureAttrs(),b=Se(m,y,r,this.config.useDateObjects),{store:_,attrsStore:E}=this._applyOptimisticUpdates(b,m,l,c),w=p?.[0]?.data?.["page-info"],D=p?.[0]?.data?.aggregate;return{q:h,hash:g,store:_,attrsStore:E,pageInfo:w,aggregate:D}});f.forEach(({hash:d,q:h,store:p,attrsStore:g,pageInfo:y,aggregate:m})=>{this.querySubs.updateInPlace(b=>{if(!b[d]){this._log.error("Missing value in querySubs",{hash:d,q:h});return}b[d].result={store:p,attrsStore:g,pageInfo:y,aggregate:m,processedTxId:c}})}),this._cleanupPendingMutationsQueries(),f.forEach(({hash:d})=>{this.notifyOne(d)});break}case"transact-ok":{const{"client-event-id":i,"tx-id":a}=n;this._inFlightMutationEventIds.delete(i);const u=this._rewriteMutations(this.ensureAttrs(),this._pendingMutations()).get(i);if(!u)break;this._updatePendingMutations(f=>{f.set(i,{...f.get(i),"tx-id":a,confirmed:Date.now()})});const l=[];for(const f of u["tx-steps"])if(f[0]==="add-attr"){const d=f[1];l.push(d)}if(l.length){const f=Object.values(this.ensureAttrs().attrs);this._setAttrs([...f,...l])}this._finishTransaction("synced",i),this._cleanupPendingMutationsTimeout();break}case"patch-presence":{const i=n["room-id"];this._trySetRoomConnected(i,!0),this._patchPresencePeers(i,n.edits),this._notifyPresenceSubs(i);break}case"refresh-presence":{const i=n["room-id"];this._trySetRoomConnected(i,!0),this._setPresencePeers(i,n.data),this._notifyPresenceSubs(i);break}case"server-broadcast":{const i=n["room-id"],a=n.topic;this._trySetRoomConnected(i,!0),this._notifyBroadcastSubs(i,a,n);break}case"join-room-ok":{const i=n["room-id"];if(!this._rooms[i]){this._roomsPendingLeave[i]&&(this._tryLeaveRoom(i),delete this._roomsPendingLeave[i]);break}this._trySetRoomConnected(i,!0),this._flushEnqueuedRoomData(i);break}case"leave-room-ok":{const i=n["room-id"];this._trySetRoomConnected(i,!1);break}case"join-room-error":const s=n["room-id"],o=this._rooms[s];o&&(o.error=n.error),this._notifyPresenceSubs(s);break;case"error":this._handleReceiveError(n);break;default:this._log.info("Uknown op",n.op,n);break}}_pendingMutations(){return this.kv.currentValue.pendingMutations??new Map}_updatePendingMutations(e){this.kv.updateInPlace(n=>{const r=n.pendingMutations??new Map;n.pendingMutations=r,e(r)})}_handleMutationError(e,n,r){const s=this._pendingMutations().get(n);if(s&&(e!=="timeout"||!s["tx-id"])){this._updatePendingMutations(i=>(i.delete(n),i)),this._inFlightMutationEventIds.delete(n);const o={message:r.message,hint:r.hint};this.notifyAll(),this.notifyAttrsSubs(),this.notifyMutationErrorSubs(o),this._finishTransaction(e,n,r)}}_handleReceiveError(e){console.log("error",e);const n=e["client-event-id"];this._inFlightMutationEventIds.delete(n);const r=this._pendingMutations().get(n),s={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa."};if(e.hint&&(s.hint=e.hint),r){this._handleMutationError("error",n,e);return}if(e["original-event"]?.hasOwnProperty("q")&&e["original-event"]?.op==="add-query"){const a=e["original-event"]?.q,c=O(a);this.notifyQueryError(O(a),s),this.notifyQueryOnceError(a,c,n,s);return}if(e["original-event"]?.op==="init"){if(e.type==="record-not-found"&&e.hint?.["record-type"]==="app-user"){this.changeCurrentUser(null);return}this._setStatus(Q.ERRORED,s),this.notifyAll();return}if(e["original-event"]?.op==="resync-table"){this._syncTable.onResyncError(e);return}if(e["original-event"]?.op==="start-sync"){this._syncTable.onStartSyncError(e);return}const i={...e};delete i.message,delete i.hint,console.error(e.message,i),e.hint&&console.error(`This error comes with some debugging information. Here it is: 
`,e.hint)}notifyQueryOnceError(e,n,r,s){const o=this.queryOnceDfds[n]?.find(i=>i.eventId===r);o&&(o.dfd.reject(s),this._completeQueryOnce(e,n,o.dfd))}_setAttrs(e){this.attrs=new se(e.reduce((n,r)=>(n[r.id]=r,n),{}),this._linkIndex),this.notifyAttrsSubs()}getPreviousResult=e=>{const n=O(e);return this.dataForQuery(n)?.data};_startQuerySub(e,n){const r=C();return this.querySubs.updateInPlace(s=>{s[n]=s[n]||{q:e,result:null,eventId:r},s[n].lastAccessed=Date.now()}),this._trySendAuthed(r,{op:"add-query",q:e}),r}subscribeTable(e,n){return this._syncTable.subscribe(e,n)}subscribeQuery(e,n,r){this.config.disableValidation||wn(e,this.config.schema),r&&"ruleParams"in r&&(e={$$ruleParams:r.ruleParams,...e});const s=O(e),o=this.getPreviousResult(e);return o&&n(o),this.queryCbs[s]=this.queryCbs[s]??[],this.queryCbs[s].push({q:e,cb:n}),this._startQuerySub(e,s),()=>{this._unsubQuery(e,s,n)}}queryOnce(e,n){this.config.disableValidation||wn(e,this.config.schema),n&&"ruleParams"in n&&(e={$$ruleParams:n.ruleParams,...e});const r=new mn;if(!this._isOnline)return r.reject(new Error("We can't run `queryOnce`, because the device is offline.")),r.promise;if(!this.querySubs)return r.reject(new Error("We can't run `queryOnce` on the backend. Use adminAPI.query instead: https://www.instantdb.com/docs/backend#query")),r.promise;const s=O(e),o=this._startQuerySub(e,s);return this.queryOnceDfds[s]=this.queryOnceDfds[s]??[],this.queryOnceDfds[s].push({q:e,dfd:r,eventId:o}),setTimeout(()=>r.reject(new Error("Query timed out")),Ni),r.promise}_completeQueryOnce(e,n,r){this.queryOnceDfds[n]&&(this.queryOnceDfds[n]=this.queryOnceDfds[n].filter(s=>s.dfd!==r),this._cleanupQuery(e,n))}_unsubQuery(e,n,r){this.queryCbs[n]&&(this.queryCbs[n]=this.queryCbs[n].filter(s=>s.cb!==r),this._cleanupQuery(e,n))}_hasQueryListeners(e){return!!(this.queryCbs[e]?.length||this.queryOnceDfds[e]?.length)}_cleanupQuery(e,n){this._hasQueryListeners(n)||(delete this.queryCbs[n],delete this.queryOnceDfds[n],delete this._dataForQueryCache[n],this.querySubs.unloadKey(n),this._trySendAuthed(C(),{op:"remove-query",q:e}))}_rewriteMutations(e,n,r){if(!e)return n;if(!n)return new Map;const s=l=>{const[f,d,h]=l["forward-identity"];return A(e,d,h)},o=l=>{const[f,d,h]=l["forward-identity"];return ie(e,d,h)},i={attrIdMap:{},refSwapAttrIds:new Set};let a=!1;const c=(l,f)=>{const d=[];for(const h of l){const[p]=h;if(p==="add-attr"){const[y,m]=h,b=s(m);if(b&&m.id!==b.id){i.attrIdMap[m.id]=b.id,a=!0;continue}if(m["value-type"]==="ref"){const _=o(m);if(_){i.attrIdMap[m.id]=_.id,i.refSwapAttrIds.add(m.id),a=!0;continue}}}if(r&&f&&r>=f&&p==="add-attr"||p==="update-attr"||p==="delete-attr"){a=!0;continue}const g=a?Io(i,h):h;d.push(g)}return a?d:l},u=new Map;for(const[l,f]of n.entries())u.set(l,{...f,"tx-steps":c(f["tx-steps"],f["tx-id"])});return a?u:n}_rewriteMutationsSorted(e,n){return ht(this._rewriteMutations(e,n).entries())}optimisticAttrs(){const e=[...this._pendingMutations().values()].flatMap(o=>o["tx-steps"]),n=new Set(e.filter(([o,i])=>o==="delete-attr").map(([o,i])=>i)),r=[];for(const[o,i]of e)if(o==="add-attr")r.push(i);else if(o==="update-attr"&&i.id&&this.attrs?.getAttr(i.id)){const a={...this.attrs.getAttr(i.id),...i};r.push(a)}if(!n.size&&!r.length)return this.attrs||new se({},this._linkIndex);const s={...this.attrs?.attrs||{}};for(const o of r)s[o.id]=o;for(const o of n)delete s[o];return new se(s,this._linkIndex)}dataForQuery(e,n=!0){const r=this._errorMessage;if(r)return{error:r};if(!this.querySubs||!this.kv.currentValue.pendingMutations)return;const s=this.querySubs.version(),o=this.querySubs.currentValue,i=this.kv.version(),a=this._pendingMutations(),{q:c,result:u}=o[e]||{};if(!u)return;const l=this._dataForQueryCache[e];if(l&&s===l.querySubVersion&&i===l.pendingMutationsVersion)return l;let f=u.store,d=u.attrsStore;const{pageInfo:h,aggregate:p,processedTxId:g}=u,y=this._rewriteMutationsSorted(d,a);if(n){const b=this._applyOptimisticUpdates(f,d,y,g);f=b.store,d=b.attrsStore}return{data:cr({store:f,attrsStore:d,pageInfo:h,aggregate:p},c),querySubVersion:s,pendingMutationsVersion:i}}_applyOptimisticUpdates(e,n,r,s){for(const[o,i]of r)if(!i["tx-id"]||s&&i["tx-id"]>s){const a=ks(e,n,i["tx-steps"]);e=a.store,n=a.attrsStore}return{store:e,attrsStore:n}}notifyOne=e=>{const n=this.queryCbs[e]??[],r=this._dataForQueryCache[e]?.data,s=this.dataForQuery(e);s?.data&&(this._dataForQueryCache[e]=s,!Be(s.data,r)&&n.forEach(o=>o.cb(s.data)))};notifyOneQueryOnce=e=>{const n=this.queryOnceDfds[e]??[],r=this.dataForQuery(e)?.data;n.forEach(s=>{this._completeQueryOnce(s.q,e,s.dfd),s.dfd.resolve(r)})};notifyQueryError=(e,n)=>{(this.queryCbs[e]||[]).forEach(s=>s.cb({error:n}))};notifyAll(){Object.keys(this.queryCbs).forEach(e=>{this.querySubs.waitForKeyToLoad(e).then(()=>this.notifyOne(e)).catch(()=>this.notifyOne(e))})}loadedNotifyAll(){this.kv.waitForKeyToLoad("pendingMutations").then(()=>this.notifyAll()).catch(()=>this.notifyAll())}pushTx=e=>{this.config.disableValidation||Pi(e,this.config.schema);try{const n=ti({attrsStore:this.optimisticAttrs(),schema:this.config.schema,stores:Object.values(this.querySubs.currentValue).map(r=>r?.result?.store),useDateObjects:this.config.useDateObjects},e);return this.pushOps(n)}catch(n){return this.pushOps([],n)}};pushOps=(e,n)=>{const r=C(),s=[...this._pendingMutations().values()],o=Math.max(0,...s.map(c=>c.order||0))+1,i={op:"transact","tx-steps":e,created:Date.now(),error:n,order:o};this._updatePendingMutations(c=>{c.set(r,i)});const a=new mn;return this.mutationDeferredStore.set(r,a),this._sendMutation(r,i),this.notifyAll(),a.promise};shutdown(){this._log.info("[shutdown]",this.config.appId),this._isShutdown=!0,this._transport?.close()}_sendMutation(e,n){if(n.error){this._handleMutationError("error",e,{message:n.error.message});return}if(this.status!==Q.AUTHENTICATED){this._finishTransaction("enqueued",e);return}const r=Math.max(6e3,Math.min(this._inFlightMutationEventIds.size+1,this._pendingMutations().size+1)*6e3);this._isOnline?(this._trySend(e,n),setTimeout(()=>{this._isOnline&&this._handleMutationError("timeout",e,{message:"transaction timed out"})},r)):this._finishTransaction("enqueued",e)}_flushPendingMessages(){Object.keys(this.queryCbs).map(o=>this.querySubs.currentValue[o]).filter(o=>o).forEach(({eventId:o,q:i})=>{this._trySendAuthed(o,{op:"add-query",q:i})}),Object.values(this.queryOnceDfds).flat().forEach(({eventId:o,q:i})=>{this._trySendAuthed(o,{op:"add-query",q:i})});const r=this._rewriteMutations(this.ensureAttrs(),this._pendingMutations());r!==this._pendingMutations()&&this.kv.updateInPlace(o=>{o.pendingMutations=r}),ht(r.entries()).forEach(([o,i])=>{i["tx-id"]||this._sendMutation(o,i)}),this._syncTable.flushPending()}_cleanupPendingMutationsQueries(){let e=Number.MAX_SAFE_INTEGER;for(const{result:n}of Object.values(this.querySubs.currentValue))n?.processedTxId&&(e=Math.min(e,n?.processedTxId));this._updatePendingMutations(n=>{for(const[r,s]of Array.from(n.entries()))s["tx-id"]&&s["tx-id"]<=e&&n.delete(r)})}_cleanupPendingMutationsTimeout(){if(this._pendingMutations().size<this._pendingMutationCleanupThreshold)return;const e=Date.now();this._updatePendingMutations(n=>{for(const[r,s]of Array.from(n.entries()))s.confirmed&&s.confirmed+this._pendingTxCleanupTimeout<e&&n.delete(r)})}_trySendAuthed(...e){this.status===Q.AUTHENTICATED&&this._trySend(...e)}_trySend(e,n,r){if(this._transport.isOpen()){switch(Mn[n.op]||this._log.info("[send]",this._transport.id,n.op,n),n.op){case"transact":{this._inFlightMutationEventIds.add(e);break}case"init":this._inFlightMutationEventIds.clear()}this._transport.send({"client-event-id":e,...n})}}_transportOnOpen=e=>{const n=e.target;if(this._transport!==n){this._log.info("[socket][open]",n.id,"skip; this is no longer the current transport");return}this._log.info("[socket][open]",this._transport.id),this._setStatus(Q.OPENED),this.getCurrentUser().then(r=>{this._trySend(C(),{op:"init","app-id":this.config.appId,"refresh-token":r.user?.refresh_token,versions:this.versions,"__admin-token":this.config.__adminToken})}).catch(r=>{this._log.error("[socket][error]",n.id,r)})};_transportOnMessage=e=>{const n=e.target,r=e.message;if(this._transport!==n){this._log.info("[socket][message]",n.id,r,"skip; this is no longer the current transport");return}if(!this._wsOk&&n.type==="ws"&&(this._wsOk=!0),this._transportType="ws",Array.isArray(e.message))for(const s of e.message)this._handleReceive(n.id,s);else this._handleReceive(n.id,e.message)};_transportOnError=e=>{const n=e.target;if(this._transport!==n){this._log.info("[socket][error]",n.id,"skip; this is no longer the current transport");return}this._log.error("[socket][error]",n.id,e)};_scheduleReconnect=()=>{!this._wsOk&&this._transportType!=="sse"&&(this._transportType="sse",this._reconnectTimeoutMs=0),setTimeout(()=>{if(this._reconnectTimeoutMs=Math.min(this._reconnectTimeoutMs+1e3,1e4),!this._isOnline){this._log.info("[socket][close]",this._transport.id,"we are offline, no need to start socket");return}this._startSocket()},this._reconnectTimeoutMs)};_transportOnClose=e=>{const n=e.target;if(this._transport!==n){this._log.info("[socket][close]",n.id,"skip; this is no longer the current transport");return}this._setStatus(Q.CLOSED);for(const r of Object.values(this._rooms))r.isConnected=!1;if(this._isShutdown){this._log.info("[socket][close]",n.id,"Reactor has been shut down and will not reconnect");return}this._log.info("[socket][close]",n.id,"schedule reconnect, ms =",this._reconnectTimeoutMs),this._scheduleReconnect()};_startSocket(){if(this._wsOk=null,this._isShutdown){this._log.info("[socket][start]",this.config.appId,"Reactor has been shut down and will not start a new socket");return}if(this._transport&&this._transport.isConnecting()){this._log.info("[socket][start]",this._transport.id,"maintained as current transport, we were still in a connecting state");return}const e=this._transport;this._transport=Hi({transportType:this._transportType,appId:this.config.appId,apiURI:this.config.apiURI,wsURI:this.config.websocketURI,EventSourceImpl:this._EventSource}),this._transport.onopen=this._transportOnOpen,this._transport.onmessage=this._transportOnMessage,this._transport.onclose=this._transportOnClose,this._transport.onerror=this._transportOnError,this._log.info("[socket][start]",this._transport.id),e?.isOpen()&&(this._log.info("[socket][start]",this._transport.id,"close previous transport id = ",e.id),e.close())}async getLocalId(e){const n=`localToken_${e}`;if(this.kv.currentValue[n])return this.kv.currentValue[n];const r=await this.kv.waitForKeyToLoad(n);if(r)return r;const s=C();return this.kv.updateInPlace(o=>{o[n]||(o[n]=s)}),await this.kv.waitForKeyToLoad(n)}_replaceUrlAfterOAuth(){if(typeof URL>"u")return;const e=new URL(window.location.href);if(e.searchParams.get(ft)){const n=e.toString();e.searchParams.delete(ft),e.searchParams.delete("code"),e.searchParams.delete("error");const r=e.pathname+(e.searchParams.size?"?"+e.searchParams:"")+e.hash;if(history.replaceState(history.state,"",r),typeof navigation=="object"&&typeof navigation.addEventListener=="function"&&typeof navigation.removeEventListener=="function"){let s=!1;const o=i=>{s||(s=!0,navigation.removeEventListener("navigate",o),!i.userInitiated&&i.navigationType==="replace"&&i.destination?.url===n&&history.replaceState(history.state,"",r))};navigation.addEventListener("navigate",o)}}}async _oauthLoginInit(){if(typeof window>"u"||typeof window.location>"u"||typeof URLSearchParams>"u")return null;const e=new URLSearchParams(window.location.search);if(!e.get(ft))return null;const n=e.get("error");if(n)return this._replaceUrlAfterOAuth(),{error:{message:n}};const r=e.get("code");if(!r)return null;this._replaceUrlAfterOAuth();try{const s=await this._getCurrentUser(),o=s?.type==="guest",{user:i}=await yn({apiURI:this.config.apiURI,appId:this.config.appId,code:r,refreshToken:o?s.refresh_token:void 0});return this.setCurrentUser(i),null}catch(s){return s?.body?.type==="record-not-found"&&s?.body?.hint?.["record-type"]==="app-oauth-code"&&await this._hasCurrentUser()?null:{error:{message:s?.body?.message||"Error logging in."}}}}async _waitForOAuthCallbackResponse(){return await this._oauthCallbackResponse}__subscribeMutationErrors(e){return this.mutationErrorCbs.push(e),()=>{this.mutationErrorCbs=this.mutationErrorCbs.filter(n=>n!==e)}}subscribeAuth(e){this.authCbs.push(e);const n=this._currentUserCached;n.isLoading||e(this._currentUserCached);let r=!1;return this.getCurrentUser().then(s=>{r||Be(s,n)||e(s)}),()=>{r=!0,this.authCbs=this.authCbs.filter(s=>s!==e)}}async getAuth(){const{user:e,error:n}=await this.getCurrentUser();if(n)throw new ke("Could not get current user: "+n.message);return e}subscribeConnectionStatus(e){return this.connectionStatusCbs.push(e),()=>{this.connectionStatusCbs=this.connectionStatusCbs.filter(n=>n!==e)}}subscribeAttrs(e){return this.attrsCbs.push(e),this.attrs&&e(this.attrs.attrs),()=>{this.attrsCbs=this.attrsCbs.filter(n=>n!==e)}}notifyAuthSubs(e){this.authCbs.forEach(n=>n(e))}notifyMutationErrorSubs(e){this.mutationErrorCbs.forEach(n=>n(e))}notifyAttrsSubs(){if(!this.attrs)return;const e=this.optimisticAttrs();this.attrsCbs.forEach(n=>n(e.attrs))}notifyConnectionStatusSubs(e){this.connectionStatusCbs.forEach(n=>n(e))}async setCurrentUser(e){this.kv.updateInPlace(n=>{n[_e]=e}),await this.kv.waitForKeyToLoad(_e)}getCurrentUserCached(){return this._currentUserCached}async _getCurrentUser(){const e=await this.kv.waitForKeyToLoad(_e);return typeof e=="string"?JSON.parse(e):e}async getCurrentUser(){const e=await this._waitForOAuthCallbackResponse();if(e?.error){const n={error:e.error,user:void 0};return this._currentUserCached={isLoading:!1,...n},n}try{const r={user:await this._getCurrentUser(),error:void 0};return this._currentUserCached={isLoading:!1,...r},r}catch(n){return{user:void 0,isLoading:!1,error:{message:n?.message||"Error loading user"}}}}async _hasCurrentUser(){const e=await this.kv.waitForKeyToLoad(_e);return typeof e=="string"?JSON.parse(e)!=null:e!=null}async changeCurrentUser(e){const{user:n}=await this.getCurrentUser();if(!Be(n,e)){await this.setCurrentUser(e),this.updateUser(e);try{this._broadcastChannel?.postMessage({type:"auth"})}catch(r){console.error("Error posting message to broadcast channel",r)}}}async syncUserToEndpoint(e){if(this.config.firstPartyPath)try{fetch(this.config.firstPartyPath+"/",{method:"POST",body:JSON.stringify({type:"sync-user",appId:this.config.appId,user:e}),headers:{"Content-Type":"application/json"}})}catch(n){this._log.error("Error syncing user with external endpoint",n)}}updateUser(e){this.syncUserToEndpoint(e);const n={error:void 0,user:e};this._currentUserCached={isLoading:!1,...n},this._dataForQueryCache={},this.querySubs.updateInPlace(r=>{Object.keys(r).forEach(s=>{delete r[s].result})}),this._reconnectTimeoutMs=0,this._transport.close(),this._oauthCallbackResponse=null,this.notifyAuthSubs(n)}sendMagicCode({email:e}){return ui({apiURI:this.config.apiURI,appId:this.config.appId,email:e})}async signInWithMagicCode({email:e,code:n}){const r=await this.getCurrentUser(),s=r?.user?.type==="guest",o=await li({apiURI:this.config.apiURI,appId:this.config.appId,email:e,code:n,refreshToken:s?r.user.refresh_token:void 0});return await this.changeCurrentUser(o.user),o}async signInWithCustomToken(e){const n=await di({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:e});return await this.changeCurrentUser(n.user),n}async signInAsGuest(){const e=await fi({apiURI:this.config.apiURI,appId:this.config.appId});return await this.changeCurrentUser(e.user),e}potentiallyInvalidateToken(e,n){const r=e?.user?.refresh_token;if(!r)return;if(n.invalidateToken===!1){this._log.info("[auth-invalidate] skipped invalidateToken");return}pi({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:r}).then(()=>{this._log.info("[auth-invalidate] completed invalidateToken")}).catch(o=>{})}async signOut(e){const n=await this.getCurrentUser();this.potentiallyInvalidateToken(n,e),await this.changeCurrentUser(null)}createAuthorizationURL({clientName:e,redirectURL:n}){const{apiURI:r,appId:s}=this.config;return`${r}/runtime/oauth/start?app_id=${s}&client_name=${e}&redirect_uri=${n}`}async exchangeCodeForToken({code:e,codeVerifier:n}){const r=await this.getCurrentUser(),s=r?.user?.type==="guest",o=await yn({apiURI:this.config.apiURI,appId:this.config.appId,code:e,codeVerifier:n,refreshToken:s?r.user.refresh_token:void 0});return await this.changeCurrentUser(o.user),o}issuerURI(){const{apiURI:e,appId:n}=this.config;return`${e}/runtime/${n}`}async signInWithIdToken({idToken:e,clientName:n,nonce:r}){const o=(await this.getCurrentUser())?.user?.refresh_token,i=await hi({apiURI:this.config.apiURI,appId:this.config.appId,idToken:e,clientName:n,nonce:r,refreshToken:o});return await this.changeCurrentUser(i.user),i}joinRoom(e,n){let r=!1;this._rooms[e]||(r=!0,this._rooms[e]={isConnected:!1,error:void 0}),this._presence[e]=this._presence[e]||{};const s=this._presence[e].result;return n&&!s&&(this._presence[e].result=this._presence[e].result||{},this._presence[e].result.user=n,this._notifyPresenceSubs(e)),r&&this._tryJoinRoom(e,n),()=>{this._cleanupRoom(e)}}_cleanupRoom(e){if(!this._presence[e]?.handlers?.length&&!Object.keys(this._broadcastSubs[e]??{}).length){const n=this._rooms[e]?.isConnected;delete this._rooms[e],delete this._presence[e],delete this._broadcastSubs[e],n?this._tryLeaveRoom(e):this._roomsPendingLeave[e]=!0}}getPresence(e,n,r={}){const s=this._rooms[n],o=this._presence[n];return!s||!o||!o.result?null:{...Ti(o.result,r,this._sessionId),isLoading:!s.isConnected,error:s.error}}publishPresence(e,n,r){const s=this._rooms[n],o=this._presence[n];if(!s||!o)return;o.result=o.result||{};const i={...o.result.user,...r};o.result.user=i,s.isConnected&&(this._trySetPresence(n,i),this._notifyPresenceSubs(n))}_trySetPresence(e,n){this._trySendAuthed(C(),{op:"set-presence","room-id":e,data:n})}_tryJoinRoom(e,n){this._trySendAuthed(C(),{op:"join-room","room-id":e,data:n}),delete this._roomsPendingLeave[e]}_tryLeaveRoom(e){this._trySendAuthed(C(),{op:"leave-room","room-id":e})}_trySetRoomConnected(e,n){const r=this._rooms[e];r&&(r.isConnected=n)}subscribePresence(e,n,r,s){const o=this.joinRoom(n,r.initialPresence||r.initialData),i={...r,roomId:n,cb:s,prev:null};return this._presence[n]=this._presence[n]||{},this._presence[n].handlers=this._presence[n].handlers||[],this._presence[n].handlers.push(i),this._notifyPresenceSub(n,i),()=>{this._presence[n].handlers=this._presence[n]?.handlers?.filter(a=>a!==i)??[],o()}}_notifyPresenceSubs(e){this._presence[e]?.handlers?.forEach(n=>{this._notifyPresenceSub(e,n)})}_notifyPresenceSub(e,n){const r=this.getPresence("",e,n);r&&(n.prev&&!wi(r,n.prev)||(n.prev=r,n.cb(r)))}_patchPresencePeers(e,n){const r=this._presence[e]?.result?.peers||{};let s=Object.fromEntries(Object.entries(r).map(([i,a])=>[i,{data:a}]));this._presence[e]?.result;const o=Je(s,i=>{for(let[a,c,u]of n)switch(c){case"+":Yr(i,a,u);break;case"r":tn(i,a,u);break;case"-":Hn(i,a);break}delete i[this._sessionId]});this._setPresencePeers(e,o)}_setPresencePeers(e,n){const r={...n};delete r[this._sessionId];const s=Object.fromEntries(Object.entries(r).map(([o,i])=>[o,i.data]));this._presence=Je(this._presence,o=>{tn(o,[e,"result","peers"],s)})}publishTopic({roomType:e,roomId:n,topic:r,data:s}){const o=this._rooms[n];if(o){if(!o.isConnected){this._broadcastQueue[n]=this._broadcastQueue[n]??[],this._broadcastQueue[n].push({topic:r,roomType:e,data:s});return}this._tryBroadcast(n,e,r,s)}}_tryBroadcast(e,n,r,s){this._trySendAuthed(C(),{op:"client-broadcast","room-id":e,roomType:n,topic:r,data:s})}subscribeTopic(e,n,r){const s=this.joinRoom(e);return this._broadcastSubs[e]=this._broadcastSubs[e]||{},this._broadcastSubs[e][n]=this._broadcastSubs[e][n]||[],this._broadcastSubs[e][n].push(r),this._presence[e]=this._presence[e]||{},()=>{this._broadcastSubs[e][n]=this._broadcastSubs[e][n].filter(o=>o!==r),this._broadcastSubs[e][n].length||delete this._broadcastSubs[e][n],s()}}_notifyBroadcastSubs(e,n,r){this._broadcastSubs?.[e]?.[n]?.forEach(s=>{const o=r.data?.data,i=r.data["peer-id"]===this._sessionId?this._presence[e]?.result?.user:this._presence[e]?.result?.peers?.[r.data["peer-id"]];return s(o,i)})}async uploadFile(e,n,r){const o=(await this.getCurrentUser())?.user?.refresh_token;return yi({...r,apiURI:this.config.apiURI,appId:this.config.appId,path:e,file:n,refreshToken:o})}async deleteFile(e){const r=(await this.getCurrentUser())?.user?.refresh_token;return await gi({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:r})}async upload(e,n){const s=(await this.getCurrentUser())?.user?.refresh_token,o=e||n.name,i=await mi({apiURI:this.config.apiURI,appId:this.config.appId,fileName:o,refreshToken:s});return await bi(i,n)}async getDownloadUrl(e){const r=(await this.getCurrentUser())?.user?.refresh_token;return await _i({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:r})}}let On;function ea(t,e){On?.dispose();const n=ia(e),r=ra(e,a),s=na(ta(t));function o(l){l.source===s.element.contentWindow&&l.data?.type==="close"&&n.isVisible()&&a()}function i(l){const f=l.shiftKey&&l.ctrlKey&&l.key==="0",d=l.key==="Escape"||l.key==="Esc";(f||d&&n.isVisible())&&a()}function a(){n.isVisible()?n.element.style.display="none":(n.element.style.display="block",n.element.contains(s.element)||n.element.appendChild(s.element))}function c(){n.element.remove(),r.element.remove(),removeEventListener("keydown",i),removeEventListener("message",o)}function u(){document.body.appendChild(n.element),document.body.appendChild(r.element),addEventListener("keydown",i),addEventListener("message",o),On={dispose:c}}return u()}function ta(t){return`${Gt||yr?"http://localhost:3000":"https://instantdb.com"}/_devtool?appId=${t}`}function na(t){const e=document.createElement("iframe");return e.src=t,e.className="instant-devtool-iframe",Object.assign(e.style,{width:"100%",height:"100%",backgroundColor:"white",border:"none"}),{element:e}}function ra(t,e){const n=`
    <svg width="32" height="32" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="512" height="512" fill="black"/>
      <rect x="97.0973" y="91.3297" width="140" height="330" fill="white"/>
    </svg>
  `,r=document.createElement("button");return r.innerHTML=n,r.className="instant-devtool-toggler",Object.assign(r.style,{position:"fixed",...sa(t.position),height:"32px",width:"32px",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"9010",padding:"0",margin:"0",border:"none",cursor:"pointer"}),r.addEventListener("click",e),{element:r}}function sa(t){switch(t){case"bottom-left":return{bottom:"24px",left:"24px"};case"bottom-right":return{bottom:"24px",right:"24px"};case"top-right":return{top:"24px",right:"24px"};case"top-left":return{top:"24px",left:"24px"}}}function oa(t){switch(t){case"bottom-left":return{bottom:"24px",right:"24px",left:"60px",top:"72px"};case"bottom-right":return{bottom:"24px",left:"24px",right:"60px",top:"72px"};case"top-right":return{top:"24px",left:"24px",right:"60px",bottom:"72px"};case"top-left":return{top:"24px",right:"24px",left:"60px",bottom:"72px"}}}function ia(t){const e=document.createElement("div");Object.assign(e.style,{position:"fixed",...oa(t.position),display:"block",borderRadius:"4px",border:"1px #ccc solid",boxShadow:"0px 0px 8px #00000044",backgroundColor:"#eee",zIndex:"999990"}),e.style.display="none",e.className="instant-devtool-container";function n(){return e.style.display!=="none"}return{element:e,isVisible:n}}const aa={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"};function ca(){return globalThis.__instantDbSchemaHashStore=globalThis.__instantDbSchemaHashStore??new WeakMap,globalThis.__instantDbSchemaHashStore}function ua(){return globalThis.__instantDbStore=globalThis.__instantDbStore??{},globalThis.__instantDbStore}function Pt(t){const e=t.__adminToken;return t.appId+"_"+(t.websocketURI||"default_ws_uri")+"_"+(t.apiURI||"default_api_uri")+"_"+(e||"client_only")+"_"+t.useDateObjects}const $t=ua(),kn=ca();class la{db;constructor(e){this.db=e}sendMagicCode=e=>this.db.sendMagicCode(e);signInWithMagicCode=e=>this.db.signInWithMagicCode(e);signInWithToken=e=>this.db.signInWithCustomToken(e);signInAsGuest=()=>this.db.signInAsGuest();createAuthorizationURL=e=>this.db.createAuthorizationURL(e);signInWithIdToken=e=>this.db.signInWithIdToken(e);exchangeOAuthCode=e=>this.db.exchangeCodeForToken(e);issuerURI=()=>this.db.issuerURI();signOut=(e={invalidateToken:!0})=>this.db.signOut(e)}class da{db;constructor(e){this.db=e}uploadFile=(e,n,r={})=>this.db.uploadFile(e,n,r);delete=e=>this.db.deleteFile(e);upload=(e,n)=>this.db.upload(e,n);put=this.upload;getDownloadUrl=e=>this.db.getDownloadUrl(e)}class fa{_reactor;auth;storage;tx=ur();constructor(e){this._reactor=e,this.auth=new la(this._reactor),this.storage=new da(this._reactor)}transact(e){return this._reactor.pushTx(e)}getLocalId(e){return this._reactor.getLocalId(e)}subscribeQuery(e,n,r){return this._reactor.subscribeQuery(e,n,r)}subscribeAuth(e){return this._reactor.subscribeAuth(e)}getAuth(){return this._reactor.getAuth()}subscribeConnectionStatus(e){return this._reactor.subscribeConnectionStatus(e)}joinRoom(e="_defaultRoomType",n="_defaultRoomId",r){return{leaveRoom:this._reactor.joinRoom(n,r?.initialPresence),subscribeTopic:(o,i)=>this._reactor.subscribeTopic(n,o,i),subscribePresence:(o,i)=>this._reactor.subscribePresence(e,n,o,i),publishTopic:(o,i)=>this._reactor.publishTopic({roomType:e,roomId:n,topic:o,data:i}),publishPresence:o=>this._reactor.publishPresence(e,n,o),getPresence:o=>this._reactor.getPresence(e,n,o)}}shutdown(){delete $t[Pt(this._reactor.config)],this._reactor.shutdown()}queryOnce(e,n){return this._reactor.queryOnce(e,n)}_syncTableExperimental(e,n){return this._reactor.subscribeTable(e,n)}}function In(t){if(!t)return"0";const e=kn.get(t);if(e)return e;const n=O(t);return kn.set(t,n),n}function ha(t,e){return In(t._reactor.config.schema)!==In(e)}function pa(t,e,n,r,s){const o={...t,appId:t.appId?.trim(),useDateObjects:t.useDateObjects??!1},i=$t[Pt(o)];if(i)return ha(i,o.schema)&&i._reactor.updateSchema(o.schema),i;const a=new Xi({...aa,...o,cardinalityInference:!!o.schema},e||fr,n||hr,{...r||{},"@instantdb/core":mr},s),c=new fa(a);return $t[Pt(o)]=c,ya(o.appId,o.devtool),c}function ya(t,e){if(typeof window>"u"||typeof window.location>"u"||typeof document>"u"||typeof e=="boolean"&&!e)return;const n={position:"bottom-right",allowedHosts:["localhost"],...typeof e=="object"?e:{}};n.allowedHosts.includes(window.location.hostname)&&ea(t,n)}const ga={},ma=typeof import.meta<"u"?ga?.VITE_INSTANTDB_APP_ID:"",ba=typeof window<"u"?window.INSTANTDB_APP_ID:"",Ar=(ma||ba||"").trim(),Xe=!!Ar,pt=Xe?pa({appId:Ar}):null;function _a(){return Xe||console.warn("InstantDB app ID missing. Set VITE_INSTANTDB_APP_ID in .env or window.INSTANTDB_APP_ID."),Xe}const Ne=document.getElementById("grid-container"),ce=40,xn=navigator.userAgent||"",Ta=/Chrome/.test(xn)&&!/Edg|OPR|Brave|Chromium/.test(xn),wa=!Ta;let Dt=[],U=-1e3,B=-1e3,he=[],Ie=0,ae=!1,Te=null,q=[],z=1,st=3,jt=null;const Pn=new Map;let pe=0,ye=0,et=!1;function Re(){document.body.classList.toggle("performance-mode",wa&&ae)}const xe={classic:{name:"Treasure Hunt",colors:{baseColor:{r:102,g:194,b:255},targetColor:{r:255,g:92,b:52},hazardColor:{r:53,g:30,b:40}},assets:{cursor:{src:"assets/cursor-eye.svg",size:32},target:{src:"assets/target-diamond.webp",size:40},hazard:{src:"assets/hazard-skull.webp",size:40},targetOptions:[{src:"assets/target-black-gem.webp",size:40},{src:"assets/target-diamond.webp",size:40},{src:"assets/target-red-gem.webp",size:40},{src:"assets/target-red-oval-gem.webp",size:40}],hazardOptions:[{src:"assets/hazard-skull.webp",size:40}]},copy:{gameTitle:"Treasure Hunt",themePrompt:"Select a theme:",levelPrompt:"Select a level to start:",levelButtonTemplate:"Level {level}",levelButtonSubtext:"{hazards} Hazards, {targets} Targets",legendTargetLabel:"Targets",legendHazardLabel:"Hazards",gameOverTitle:"Game Over!",gameOverMessage:"You were caught by a hazard!",levelCompleteTitle:"Level {level} Complete!",levelCompleteMessage:"All targets found!",nextLevelCta:"Next Level",restartCta:"Restart Game",playAgainCta:"Play Again",saveScoreCta:"Save Score",finishRunCta:"Finish Run"},levelOverrides:{2:{target:{src:"assets/target-crown.svg"}},3:{target:{src:"assets/target-trophy.svg"}}},dotGrid:{type:"symbols",characters:"",fontSize:20,fontFamily:"Arial, sans-serif",colorSource:"custom",color:{r:215,g:239,b:255}},dotBehavior:{pushRadius:150,maxPushDistance:60,scaleRadius:150,maxScale:1.5,visibilityRadius:250,fullVisibilityRadius:100,baseJitterAmount:2,dangerShakeAmount:20,dangerShakeExponent:1.5,dangerZone:200}},severance:{name:"Severance",colors:{baseColor:{r:0,g:139,b:146},targetColor:{r:226,g:250,b:251},hazardColor:{r:7,g:48,b:75}},assets:{cursor:{src:"assets/cursor-eye.svg",size:32},target:{src:"assets/target-gem.webp",size:40},hazard:{src:"assets/hazard-skull.webp",size:40}},copy:{gameTitle:"Severance Hunt",themePrompt:"Select a theme:",levelPrompt:"Select a level to start:",levelButtonTemplate:"Level {level}",levelButtonSubtext:"{hazards} Hazards, {targets} Targets",legendTargetLabel:"Targets",legendHazardLabel:"Hazards",gameOverTitle:"Game Over!",gameOverMessage:"You were caught by a hazard!",levelCompleteTitle:"Level {level} Complete!",levelCompleteMessage:"All targets found!",nextLevelCta:"Next Level",restartCta:"Restart Game",playAgainCta:"Play Again",saveScoreCta:"Save Score",finishRunCta:"Finish Run"},levelOverrides:{},dotGrid:{type:"mixed",characters:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",fontSize:14,fontFamily:"monospace",fontWeight:"bold",colorSource:"hazard"},dotBehavior:{pushRadius:150,maxPushDistance:60,scaleRadius:150,maxScale:1.5,visibilityRadius:250,fullVisibilityRadius:100,baseJitterAmount:2.5,dangerShakeAmount:20,dangerShakeExponent:1.5,dangerZone:200}},forest:{name:"Firefly Forest",colors:{baseColor:{r:52,g:97,b:69},targetColor:{r:255,g:185,b:80},hazardColor:{r:50,g:33,b:22}},assets:{cursor:{src:"assets/cursor-eye.svg",size:32},target:{src:"assets/target-gem.webp",size:40},hazard:{src:"assets/hazard-skull.webp",size:40}},copy:{gameTitle:"Firefly Forest",themePrompt:"Select a theme:",levelPrompt:"Select a level to start:",levelButtonTemplate:"Level {level}",levelButtonSubtext:"{hazards} Hazards, {targets} Targets",legendTargetLabel:"Targets",legendHazardLabel:"Hazards",gameOverTitle:"Game Over!",gameOverMessage:"You were caught by a hazard!",levelCompleteTitle:"Level {level} Complete!",levelCompleteMessage:"All targets found!",nextLevelCta:"Next Level",restartCta:"Restart Game",playAgainCta:"Play Again",saveScoreCta:"Save Score",finishRunCta:"Finish Run"},levelOverrides:{},dotGrid:{type:"symbols",characters:"",fontSize:10,fontFamily:"Arial, sans-serif"},dotBehavior:{pushRadius:200,maxPushDistance:40,scaleRadius:180,maxScale:1.3,visibilityRadius:280,fullVisibilityRadius:120,dangerShakeAmount:10,dangerShakeExponent:1.2,dangerZone:200}}};let k="classic",ge={...xe.classic.colors.baseColor},ot={...xe.classic.colors.targetColor},it={...xe.classic.colors.hazardColor};const $n=400,Dn=300;function H(t){return xe[t]||xe.classic}function yt(t,e={}){return{...t,...e}}function He(t){return t?typeof t=="string"?{src:t}:t:null}function va(t=[]){if(!t.length)return null;const e=t[Math.floor(Math.random()*t.length)];return He(e)}function Sa(t=[],e){if(!t.length)return null;if(t.length===1)return He(t[0]);const n=t.filter(o=>He(o)?.src!==e),r=n.length?n:t,s=r[Math.floor(Math.random()*r.length)];return He(s)}function Aa(t=k){const e=H(t),n=Pn.get(t)||{},r=Sa(e.assets?.targetOptions,n.targetSrc),s=va(e.assets?.hazardOptions);jt={...r?{target:r}:{},...s?{hazard:s}:{}},r?.src&&Pn.set(t,{...n,targetSrc:r.src})}const Pe=new Map,jn=new Map;let X=null;function Ca(){if(X)return;const t={root:null,rootMargin:"50px",threshold:0};X=new IntersectionObserver(e=>{e.forEach(n=>{const r=Pe.get(n.target);r&&(n.isIntersecting?r.play?r.play():r.start&&r.start():r.pause&&r.pause())})},t)}Ca();class Ea{constructor(e,n){this.element=e,this.asset=n,this.isPlaying=!1,this.currentFrame=0,this.animationFrame=null,this.lastFrameTime=0}start(){this.isPlaying||(this.isPlaying=!0,this.lastFrameTime=performance.now(),this.animate())}animate(){if(!this.isPlaying)return;const e=performance.now(),n=this.asset.frameDuration||100;if(e-this.lastFrameTime>=n){this.currentFrame=(this.currentFrame+1)%this.asset.frames;const r=this.asset.size||40,s=-this.currentFrame*r;this.element.style.backgroundPosition=`${s}px 0`,this.lastFrameTime=e}this.animationFrame=requestAnimationFrame(()=>this.animate())}pause(){this.isPlaying=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null)}destroy(){this.pause(),this.element=null}}function $e(t){const e=Pe.get(t);e&&(e.destroy&&e.destroy(),Pe.delete(t)),X&&t&&X.unobserve(t)}async function Ma(t,e){try{let n=jn.get(e.src);if(!n){const s=await fetch(e.src);if(!s.ok)throw new Error(`Failed to load SVG: ${s.statusText}`);n=await s.text(),jn.set(e.src,n)}t.innerHTML=n;const r=t.querySelector("svg");return r&&(r.style.width="100%",r.style.height="100%",r.style.display="block"),!0}catch(n){return console.error("Error loading animated SVG:",n),!1}}async function ne(t,e){if(!t||!e||!e.src)return;const n=e.size||40;t.style.width=`${n}px`,t.style.height=`${n}px`,$e(t),t.style.backgroundImage="",t.innerHTML="";let r=e.type;switch(r||(e.src.endsWith(".json")?r="lottie":e.src.endsWith(".svg")?r="svg":e.src.match(/\.(png|jpg|jpeg|gif|webp)$/i)&&(r=e.frames?"sprite":"image")),r){case"lottie":if(window.lottie){const o=window.lottie.loadAnimation({container:t,renderer:"svg",loop:!0,autoplay:!0,path:e.src});Pe.set(t,o),X&&X.observe(t)}else console.warn("Lottie library not loaded");break;case"animated-svg":await Ma(t,e);break;case"sprite":if(!e.frames){console.error("Sprite asset missing frames property");return}t.style.backgroundImage=`url(${e.src})`,t.style.backgroundSize=`${e.frames*100}% 100%`,t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="0 0";const s=new Ea(t,e);s.start(),Pe.set(t,s),X&&X.observe(t);break;default:t.style.backgroundImage=`url(${e.src})`,t.style.backgroundSize="contain",t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="center";break}}function Rt(t,e){return t.replace(/\{(\w+)\}/g,(n,r)=>Object.prototype.hasOwnProperty.call(e,r)?e[r]:n)}function Oa(t){return t.replace(/\s+/g," ").trim()}async function ka(t){if(et)return{ok:!1,error:"Score already saved for this run."};if(!_a()||!pt)return{ok:!1,error:"Leaderboard is not configured yet."};const e={nickname:t,totalTargets:pe,levelsCompleted:ye,createdAt:Date.now()};try{return await pt.transact(pt.tx.leaderboard_entries[C()].update(e)),et=!0,{ok:!0}}catch{return{ok:!1,error:"Could not save score. Please try again."}}}function Cr({title:t,description:e}){const n=document.createElement("div");n.className="score-modal-overlay",n.innerHTML=`
        <div class="score-modal-card" role="dialog" aria-modal="true">
            <h2>${t}</h2>
            <p>${e}</p>
            <form class="score-form">
                <label class="score-label" for="score-nickname-input">Nickname</label>
                <input id="score-nickname-input" class="score-input" type="text" maxlength="20" placeholder="Your name" />
                <div class="score-error" aria-live="polite"></div>
                <div class="score-actions">
                    <button type="button" class="score-cancel">Cancel</button>
                    <button type="submit" class="score-submit">Save</button>
                </div>
            </form>
        </div>
    `;const r=n.querySelector("#score-nickname-input"),s=n.querySelector(".score-error"),o=n.querySelector(".score-cancel"),i=n.querySelector(".score-submit"),a=n.querySelector(".score-form"),c=()=>{n.remove(),document.removeEventListener("keydown",u)},u=l=>{l.key==="Escape"&&c()};Xe?et&&(s.textContent="Score already saved for this run.",i.disabled=!0):(s.textContent="Leaderboard setup missing. Add your InstantDB app ID first.",i.disabled=!0),o.addEventListener("click",c),n.addEventListener("click",l=>{l.target===n&&c()}),a.addEventListener("submit",async l=>{l.preventDefault();const f=Oa(r.value||"");if(!f){s.textContent="Please enter a nickname.";return}if(f.length<2){s.textContent="Nickname must be at least 2 characters.";return}if(f.length>20){s.textContent="Nickname must be 20 characters or fewer.";return}i.disabled=!0,o.disabled=!0,i.textContent="Saving...",s.textContent="";const d=await ka(f);if(!d.ok){i.disabled=!1,o.disabled=!1,i.textContent="Save",s.textContent=d.error;return}i.textContent="Saved!",setTimeout(()=>{window.location.href="leaderboard.html"},400)}),document.body.appendChild(n),document.addEventListener("keydown",u),r&&r.focus()}function Er(t){const e=document.getElementById("start-title"),n=document.getElementById("theme-prompt"),r=document.getElementById("level-prompt");e&&(e.textContent=t.copy.gameTitle),n&&(n.textContent=t.copy.themePrompt),r&&(r.textContent=t.copy.levelPrompt)}function Mr(t){const e=H(t);document.querySelectorAll(".level-button").forEach(n=>{const r=parseInt(n.getAttribute("data-level"),10),s=be(r,t),o=n.querySelector(".level-label"),i=n.querySelector(".level-subtext");o&&(o.textContent=Rt(e.copy.levelButtonTemplate,{level:r})),i&&(i.textContent=Rt(e.copy.levelButtonSubtext,{hazards:s.hazards,targets:s.targets}))})}function Or(t){const e=H(t),n=document.getElementById("target-label"),r=document.getElementById("hazard-label");n&&(n.textContent=e.copy.legendTargetLabel),r&&(r.textContent=e.copy.legendHazardLabel)}function at(t,e){const n=be(t,e);ne(document.getElementById("custom-cursor"),n.assets.cursor),ne(document.getElementById("target-legend-icon"),n.assets.target),ne(document.getElementById("hazard-legend-icon"),n.assets.hazard),ne(document.getElementById("target-indicator-icon"),n.assets.target),ne(document.getElementById("hazard-indicator-icon"),n.assets.hazard)}function be(t,e=k){const n=H(e),r=n.levelOverrides&&n.levelOverrides[t]?n.levelOverrides[t]:{},s=e===k&&jt?jt:{},o={...r.target,...s.target},i=Math.min(t,8),a=3+(t-1)*2;return{hazards:i,targets:a,assets:{cursor:yt(n.assets.cursor,r.cursor),target:yt(n.assets.target,o),hazard:yt(n.assets.hazard,r.hazard)},movingHazards:!0}}function kr(){const t=be(z);q=[];const e=250,n=t.assets.hazard,r=n.size||40,s=r/2;for(let o=0;o<t.hazards;o++){const i=document.createElement("div");i.className="hazard",ne(i,n);let a,c,u,l;do{a=Math.random()*(window.innerWidth-r*2)+r,c=Math.random()*(window.innerHeight-r*2)+r,u=q.some(y=>{const m=a-y.x,b=c-y.y;return Math.sqrt(m*m+b*b)<200});const h=a-U,p=c-B;l=Math.sqrt(h*h+p*p)<e}while(u||l);i.style.left=`${a-s}px`,i.style.top=`${c-s}px`,document.body.appendChild(i);const f=.5,d=Math.random()*Math.PI*2;q.push({element:i,x:a,y:c,size:r,velocityX:Math.cos(d)*f,velocityY:Math.sin(d)*f})}}function Ir(){const t=be(z);st=t.targets,he=[];const e=200,n=t.assets.target,r=n.size||40,s=r/2;for(let o=0;o<t.targets;o++){const i=document.createElement("div");i.className="target",ne(i,n);let a,c,u,l;do{a=Math.random()*(window.innerWidth-r*2)+r,c=Math.random()*(window.innerHeight-r*2)+r,u=q.some(p=>{const g=a-p.x,y=c-p.y;return Math.sqrt(g*g+y*y)<150});const f=a-U,d=c-B;l=Math.sqrt(f*f+d*d)<e}while(u||l);i.style.left=`${a-s}px`,i.style.top=`${c-s}px`,document.body.appendChild(i),he.push({element:i,x:a,y:c,size:r,revealed:!1,hasBeenHovered:!1})}}function Ia(t){return t[Math.floor(Math.random()*t.length)]}function xa(t,e){if(!e){t.className="dot";return}if(e.type==="dots")t.className="dot";else{t.className="dot dot-text";const n=Ia(e.characters);t.textContent=n,e.fontSize&&(t.style.fontSize=`${e.fontSize}px`),e.fontFamily&&(t.style.fontFamily=e.fontFamily),e.fontWeight&&(t.style.fontWeight=e.fontWeight)}}function xr(){const t=window.innerWidth,e=window.innerHeight,n=Math.ceil(t/ce)+1,r=Math.ceil(e/ce)+1;Ne.style.gridTemplateColumns=`repeat(${n}, ${ce}px)`,Ne.style.gridTemplateRows=`repeat(${r}, ${ce}px)`,Ne.innerHTML="",Dt=[];const o=H(k).dotGrid;for(let i=0;i<r;i++)for(let a=0;a<n;a++){const c=document.createElement("div");xa(c,o);const u=a*ce,l=i*ce;Dt.push({element:c,originalX:u,originalY:l,currentX:u,currentY:l}),Ne.appendChild(c)}}function Pa(){be(z),ae&&q.forEach(t=>{t.x+=t.velocityX,t.y+=t.velocityY;const e=Math.max(40,t.size);(t.x<e||t.x>window.innerWidth-e)&&(t.velocityX*=-1,t.x=Math.max(e,Math.min(window.innerWidth-e,t.x))),(t.y<e||t.y>window.innerHeight-e)&&(t.velocityY*=-1,t.y=Math.max(e,Math.min(window.innerHeight-e,t.y))),t.element.style.left=`${t.x-t.size/2}px`,t.element.style.top=`${t.y-t.size/2}px`})}function Pr(){const t=H(k),e=t.dotBehavior||{pushRadius:150,maxPushDistance:60,scaleRadius:150,maxScale:1.5,visibilityRadius:250,fullVisibilityRadius:100,dangerShakeAmount:20,dangerShakeExponent:1.5,dangerZone:200};let n=1/0;q.forEach(o=>{const i=U-o.x,a=B-o.y,c=Math.sqrt(i*i+a*a);c<n&&(n=c)});const r=n<e.dangerZone,s=r?1-n/e.dangerZone:0;Dt.forEach(o=>{const i=U-o.originalX,a=B-o.originalY,c=Math.sqrt(i*i+a*a);let u=0;c<e.fullVisibilityRadius?u=1:c<e.visibilityRadius&&(u=1-(c-e.fullVisibilityRadius)/(e.visibilityRadius-e.fullVisibilityRadius)),o.element.style.opacity=u;let l=1;const f=Math.max(e.scaleRadius||0,e.visibilityRadius||0);if(f>0&&(l=1+(1-Math.min(c,f)/f)*(e.maxScale-1)),c<e.pushRadius){let d=(1-c/e.pushRadius)*e.maxPushDistance;if(r){const h=e.hazardJitterBoost||1.6,p=Math.pow(s,e.dangerShakeExponent)*e.dangerShakeAmount*h,g=(Math.random()-.5)*p,y=(Math.random()-.5)*p,m=e.baseJitterAmount||0,b=(Math.random()-.5)*m,_=(Math.random()-.5)*m,E=Math.atan2(a,i),w=-Math.cos(E)*d+g+b,D=-Math.sin(E)*d+y+_;o.element.style.transform=`translate(${w}px, ${D}px) scale(${l})`;const F=Math.floor(s*220),G=gt(t,We),Le=`rgba(${Math.min(255,G.r+80)}, ${Math.max(0,G.g-F)}, ${Math.max(0,G.b-F)}, 0.6)`;o.element.classList.contains("dot-text")?o.element.style.color=Le:o.element.style.backgroundColor=Le}else{const h=Math.atan2(a,i),p=r&&e.baseJitterAmount||0,g=(Math.random()-.5)*p,y=(Math.random()-.5)*p,m=-Math.cos(h)*d+g,b=-Math.sin(h)*d+y,_=gt(t,We),E=`rgba(${_.r}, ${_.g}, ${_.b}, 0.5)`;o.element.style.transform=`translate(${m}px, ${b}px) scale(${l})`,o.element.classList.contains("dot-text")?o.element.style.color=E:o.element.style.backgroundColor=E}}else{const d=gt(t,We),h=`rgba(${d.r}, ${d.g}, ${d.b}, 0.5)`,p=r&&e.baseJitterAmount||0,g=(Math.random()-.5)*p,y=(Math.random()-.5)*p;o.element.style.transform=`translate(${g}px, ${y}px) scale(${l})`,o.element.classList.contains("dot-text")?o.element.style.color=h:o.element.style.backgroundColor=h}}),Pa(),requestAnimationFrame(Pr)}function $a(){let t=1/0,e=null;return he.forEach(n=>{if(!n.revealed&&!n.hasBeenHovered){const r=U-n.x,s=B-n.y,o=Math.sqrt(r*r+s*s);o<t&&(t=o,e=n)}}),e&&t<50?Te!==e&&(Te=e):Te&&t>=50&&(Te.hasBeenHovered=!0,Te=null),t}function Rn(t,e,n){return{r:Math.round(t.r+(e.r-t.r)*n),g:Math.round(t.g+(e.g-t.g)*n),b:Math.round(t.b+(e.b-t.b)*n)}}function $r(){const t=document.getElementById("target-count");t.textContent=st-Ie}function Da(){const t=document.getElementById("hazard-count"),e=be(z);t.textContent=e.hazards}function Dr(){at(z,k)}function ja(t,e){const n=document.getElementById("cursor-indicators"),r=document.getElementById("target-fill"),s=document.getElementById("hazard-fill"),o=25;n.style.left=`${U+o}px`,n.style.top=`${B}px`,n.style.opacity="1";const i=400,a=300,c=Math.max(0,Math.min(100,(1-t/i)*100)),u=Math.max(0,Math.min(100,(1-e/a)*100));r.style.width=`${c}%`,s.style.width=`${u}%`}function Ra(){const t=document.getElementById("start-title");if(!t)return;const e=t.textContent||"",n=()=>{const s=t.getBoundingClientRect();t.style.minHeight=`${s.height}px`,t.style.minWidth=`${s.width}px`,t.style.display="inline-block"},r=()=>{t.textContent="",t.style.visibility="visible";let s=0;const o=()=>{s<=e.length&&(t.textContent=e.slice(0,s),s+=1,setTimeout(o,80))};o()};document.fonts&&document.fonts.ready?document.fonts.ready.then(()=>{n(),r()}):(n(),r())}function La(){const t=document.getElementById("classic-shapes-layer");if(!t)return;t.innerHTML="";const e=["","","","","",""],n=192;for(let r=0;r<n;r++){const s=document.createElement("div");s.className="classic-shape",s.textContent=e[Math.floor(Math.random()*e.length)];const o=Math.floor(Math.random()*26)+10,i=Math.random()*100,a=Math.random()*10+6,c=Math.random()*6,u=(Math.random()-.5)*40;s.style.fontSize=`${o}px`,s.style.left=`${i}%`,s.style.animationDuration=`${a}s`,s.style.animationDelay=`${c}s`,s.style.transform=`translateX(${u}px)`,t.appendChild(s)}}function Ua(t){return{r:Math.min(255,t.r+120),g:Math.min(255,t.g+120),b:Math.min(255,t.b+120)}}function gt(t,e){return t.dotGrid?.colorSource==="custom"&&t.dotGrid.color?{...t.dotGrid.color}:t.dotGrid?.colorSource==="hazard"?{...t.colors.hazardColor}:Ua(e)}let We={...ge};function jr(){const t=$a();let e=1/0;q.forEach(u=>{const l=U-u.x,f=B-u.y,d=Math.sqrt(l*l+f*f);d<e&&(e=d)}),ja(t,e);let n={...ge};if(t<$n){const u=1-t/$n;n=Rn(ge,ot,u)}if(e<Dn){const u=1-e/Dn;n=Rn(n,it,u)}We=n;const r=n,s={r:Math.max(0,n.r-20),g:Math.max(0,n.g-20),b:Math.max(0,n.b-20)},i=U/window.innerWidth*360,a=`rgb(${r.r}, ${r.g}, ${r.b})`,c=`rgb(${s.r}, ${s.g}, ${s.b})`;document.body.style.background=`linear-gradient(${i}deg, ${a} 0%, ${c} 100%)`}function za(t,e){const n=document.createElement("div");n.className="plus-one",n.textContent="+1",n.style.left=`${t}px`,n.style.top=`${e-30}px`,document.body.appendChild(n),setTimeout(()=>{n.remove()},1e3)}function Fa(){q.forEach(t=>{const e=U-t.x,n=B-t.y;Math.sqrt(e*e+n*n)<40&&Na()})}function Na(){ae=!1,document.body.classList.remove("game-started"),Re(),q.forEach(r=>{r.element.classList.add("revealed")});const t=document.createElement("div");t.id="game-over-screen";const e=H(k);t.innerHTML=`
        <h1>${e.copy.gameOverTitle}</h1>
        <p>${e.copy.gameOverMessage}</p>
        <p>Level: ${z}</p>
        <p>Targets found: ${Ie}/${st}</p>
        <p>Total targets collected: ${pe}</p>
        <p>Levels completed: ${ye}</p>
        <div class="score-actions-row">
            <button id="save-score-button">${e.copy.saveScoreCta}</button>
            <button id="restart-button">${e.copy.playAgainCta}</button>
        </div>
    `,document.body.appendChild(t),document.getElementById("restart-button").addEventListener("click",()=>{location.reload()});const n=document.getElementById("save-score-button");n&&n.addEventListener("click",()=>{Cr({title:"Save your score",description:`Targets: ${pe}  Levels: ${ye}`})})}function qa(){ye+=1,ae=!1,document.body.classList.remove("game-started"),Re();const t=H(k),e=document.createElement("div");e.id="level-complete-screen",e.innerHTML=`
        <h1>${Rt(t.copy.levelCompleteTitle,{level:z})}</h1>
        <p>${t.copy.levelCompleteMessage}</p>
        <p>Ready for the next challenge?</p>
        <button id="next-level-button">${t.copy.nextLevelCta}</button>
        <button id="finish-run-button" style="margin-left: 10px;">${t.copy.finishRunCta}</button>
        <button id="restart-button" style="margin-left: 10px;">${t.copy.restartCta}</button>
    `,document.body.appendChild(e);const n=document.getElementById("next-level-button"),r=document.getElementById("finish-run-button"),s=document.getElementById("restart-button");n&&n.addEventListener("click",()=>{e.remove(),document.body.classList.add("game-started"),z++,Rr()}),s&&s.addEventListener("click",()=>{location.reload()}),r&&r.addEventListener("click",()=>{Cr({title:"Save your score",description:`Targets: ${pe}  Levels: ${ye}`})})}function Ka(){he.forEach(t=>{const e=U-t.x,n=B-t.y;Math.sqrt(e*e+n*n)<50&&!t.revealed&&(t.element.classList.add("revealed"),t.revealed=!0,Ie++,pe++,$r(),za(t.x,t.y),jr(),Ie>=st&&setTimeout(()=>{qa()},500))})}function Rr(){ae=!0,document.body.classList.add("game-started"),Ie=0,Aa(k),Re(),document.getElementById("game-legend").style.display="flex",document.getElementById("level-indicator").style.display="block",Ba(),he.forEach(t=>{$e(t.element),t.element.remove()}),q.forEach(t=>{$e(t.element),t.element.remove()}),xr(),kr(),Ir(),Da(),$r(),Dr(),at(z,k)}function Lr(t=1){const e=document.getElementById("start-screen");e.style.display="none",document.body.classList.add("game-started"),pe=0,ye=0,et=!1,z=t,Re(),Rr(),Pr()}function Ba(){const t=document.getElementById("level-display");t&&(t.textContent=`Level ${z}`)}function Va(t,e){const n=document.getElementById("custom-cursor");n&&(n.style.left=`${t}px`,n.style.top=`${e}px`)}document.addEventListener("mousemove",t=>{U=t.clientX,B=t.clientY,Va(U,B),ae&&(jr(),Ka(),Fa())});document.addEventListener("mousedown",()=>{});document.addEventListener("mouseup",()=>{});function Qt(t){const e=t.colors.baseColor,n=`rgb(${e.r}, ${e.g}, ${e.b})`,r=`rgb(${Math.min(255,e.r+40)}, ${Math.min(255,e.g+40)}, ${Math.min(255,e.b+40)})`;document.body.style.background=`linear-gradient(135deg, ${n} 0%, ${r} 100%)`}document.querySelectorAll(".theme-button").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".theme-button").forEach(n=>{n.classList.remove("selected")}),t.classList.add("selected"),k=t.getAttribute("data-theme");const e=H(k);ge={...e.colors.baseColor},ot={...e.colors.targetColor},it={...e.colors.hazardColor},Qt(e),Er(e),Mr(k),Or(k),at(z,k)})});document.querySelectorAll(".level-button").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".level-button").forEach(n=>{n.classList.remove("selected")}),t.classList.add("selected");const e=parseInt(t.getAttribute("data-level"));setTimeout(()=>{Lr(e)},300)})});const Ln=document.getElementById("start-button");Ln&&Ln.addEventListener("click",()=>{k="classic";const t=H("classic");ge={...t.colors.baseColor},ot={...t.colors.targetColor},it={...t.colors.hazardColor},Qt(t),Lr(1)});window.addEventListener("resize",()=>{ae&&(xr(),he.forEach(t=>{$e(t.element),t.element.remove()}),q.forEach(t=>{$e(t.element),t.element.remove()}),kr(),Ir(),Dr())});document.addEventListener("DOMContentLoaded",()=>{document.body.classList.remove("game-started"),Re();const t=document.querySelector('.theme-button[data-theme="classic"]');if(t){t.classList.add("selected");const e=H("classic");ge={...e.colors.baseColor},ot={...e.colors.targetColor},it={...e.colors.hazardColor},Qt(e),Er(e),Mr("classic"),Or("classic"),at(1,"classic")}Ra(),La()});
